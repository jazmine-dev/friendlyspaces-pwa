<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Friendly Spaces</title>
    <meta name="theme-color" content="#1E52BA">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icons/icon-192.png">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
    <style>
        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            overflow: hidden;
            min-height: 100dvh;
            display: flex;
            flex-direction: column;
            background: #f7f5f1;
        }

        #container {
            display: flex;
            flex: 1;
            min-height: 0;
        }

        #app-header {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 16px;
            padding: 16px 20px;
            background: #1E52BA;
            position: relative;
        }

        #brand {
            display: flex;
            align-items: center;
            gap: 12px;
            margin: 0 auto;
        }

        #brand-logo-wrap {
            display: flex;
            align-items: center;
            justify-content: center;
            background: transparent;
            padding: 0;
        }

        #brand-logo {
            display: block;
            height: 24px;
            width: auto;
        }

        #app-title {
            margin: 0;
            font-size: 18px;
            font-weight: 700;
            color: white;
            display: none;
        }

        #menu-toggle {
            border: none;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            padding: 8px 10px;
            border-radius: 12px;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            font-size: 16px;
            font-weight: 700;
            position: absolute;
            right: 16px;
        }

        #menu-toggle svg {
            width: 20px;
            height: 20px;
        }

        #menu-backdrop {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.3);
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s ease;
            z-index: 1004;
        }

        #menu-backdrop.visible {
            opacity: 1;
            pointer-events: auto;
        }

        #menu-drawer {
            position: fixed;
            top: 0;
            right: 0;
            width: min(300px, 84vw);
            height: 100%;
            background: #ffffff;
            box-shadow: -8px 0 24px rgba(0,0,0,0.15);
            transform: translateX(100%);
            transition: transform 0.25s ease;
            z-index: 1005;
            display: flex;
            flex-direction: column;
            padding: 18px;
            gap: 16px;
        }

        #menu-drawer.open {
            transform: translateX(0);
        }

        #menu-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
        }

        #menu-title {
            margin: 0;
            font-size: 16px;
            font-weight: 700;
            color: #1c1b19;
        }

        #menu-close {
            border: none;
            background: #f0ebe4;
            color: #3b3834;
            padding: 6px 10px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 700;
        }

        .menu-button {
            width: 100%;
            border: 1px solid #e8e3dc;
            background: #ffffff;
            border-radius: 12px;
            padding: 12px 14px;
            font-size: 14px;
            font-weight: 600;
            color: #1c1b19;
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
        }

        .menu-section-title {
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.06em;
            color: #7b7873;
            margin: 0;
        }

        #language-toggle {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px;
            border-radius: 999px;
            background: #f0ebe4;
        }

        #language-toggle button {
            border: none;
            background: transparent;
            padding: 6px 10px;
            border-radius: 999px;
            font-size: 11px;
            font-weight: 700;
            color: #4c4a45;
            cursor: pointer;
        }

        #language-toggle button.active {
            background: #1E52BA;
            color: white;
        }

        .fullscreen-panel {
            position: fixed;
            inset: 0;
            background: #ffffff;
            z-index: 1006;
            display: flex;
            flex-direction: column;
            transform: translateY(100%);
            transition: transform 0.25s ease;
        }

        .fullscreen-panel.open {
            transform: translateY(0);
        }

        .fullscreen-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px 18px;
            border-bottom: 1px solid #eee;
            background: #ffffff;
        }

        .fullscreen-title {
            margin: 0;
            font-size: 18px;
            font-weight: 700;
            color: #1c1b19;
        }

        .fullscreen-close {
            border: none;
            background: #f0ebe4;
            color: #3b3834;
            padding: 6px 12px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 700;
        }

        .fullscreen-body {
            padding: 18px;
            overflow-y: auto;
            flex: 1;
        }

        .suggest-toggle {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .suggest-toggle button {
            border: 2px solid #e9ecef;
            background: #f8f9fa;
            border-radius: 14px;
            padding: 12px 10px;
            font-size: 13px;
            font-weight: 700;
            cursor: pointer;
            color: #3b3834;
        }

        .suggest-toggle button.active {
            background: #1E52BA;
            border-color: #1E52BA;
            color: #ffffff;
        }

        .suggest-form {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-top: 16px;
        }

        .suggest-form label {
            font-size: 12px;
            font-weight: 600;
            color: #4c4a45;
        }

        .suggest-form input,
        .suggest-form textarea {
            width: 100%;
            padding: 10px 12px;
            border-radius: 12px;
            border: 1px solid #e6e1da;
            font-size: 14px;
        }

        .suggest-form textarea {
            min-height: 100px;
            resize: vertical;
        }

        .suggest-submit {
            border: none;
            background: #1E52BA;
            color: #ffffff;
            border-radius: 14px;
            padding: 12px 14px;
            font-size: 14px;
            font-weight: 700;
            cursor: pointer;
        }

        #sheet-backdrop {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1005;
        }

        #sheet-backdrop.visible {
            display: block;
        }

        #drag-handle {
            display: none;
            width: 40px;
            height: 5px;
            background: #ccc;
            border-radius: 3px;
            margin: 8px auto 4px;
        }

        @media (max-width: 768px) {
            #drag-handle {
                display: block;
            }
        }

        #sidebar {
            width: 350px;
            background: #1E52BA;
            box-shadow: 2px 0 8px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            z-index: 1001;
            transition: transform 0.3s ease;
            padding-bottom: 72px;
        }

        #sidebar.collapsed {
            transform: translateX(-350px);
        }

        #sidebar-header {
            padding: 20px;
            background: #1E52BA;
            color: white;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        #sidebar-header h2 {
            margin: 0 0 10px 0;
            font-size: 20px;
        }

        .language-toggle {
            display: none;
        }

        #search-container {
            position: relative;
        }

        #sidebar-actions {
            display: flex;
            gap: 10px;
            padding: 0 20px 12px;
            justify-content: center;
        }

        #search-input {
            width: 100%;
            padding: 12px 40px 12px 15px;
            border: none;
            border-radius: 25px;
            font-size: 14px;
            outline: none;
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
        }

        #search-icon {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #1E52BA;
        }

        #search-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border-radius: 15px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            margin-top: 8px;
            max-height: 200px;
            overflow-y: auto;
            display: none;
            z-index: 1000;
        }

        #search-dropdown.show {
            display: block;
        }

        .search-dropdown-item {
            padding: 12px 15px;
            cursor: pointer;
            border-bottom: 1px solid #f0f0f0;
            font-size: 13px;
        }

        .search-dropdown-item:last-child {
            border-bottom: none;
        }

        .search-dropdown-item:hover {
            background: #f8f9fa;
        }

        .search-dropdown-item strong {
            color: #1E52BA;
        }

        #favorites-tabs {
            display: flex;
            gap: 8px;
        }

        .tab-button {
            flex: 1;
            border: none;
            border-radius: 18px;
            padding: 8px 10px;
            font-size: 13px;
            cursor: pointer;
            background: rgba(255,255,255,0.2);
            color: white;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            transition: background 0.2s ease;
        }

        .tab-button.active {
            background: white;
            color: #1E52BA;
            font-weight: 600;
        }

        .tab-badge {
            background: #BA1E1E;
            color: white;
            border-radius: 12px;
            padding: 2px 6px;
            font-size: 11px;
            min-width: 18px;
            text-align: center;
        }

        #filters-container {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            color: #ffffff;
            text-align: center;
        }

        .filter-category {
            margin-bottom: 25px;
            border-radius: 12px;
            border: 1px solid rgba(255,255,255,0.25);
            padding: 12px;
            background: rgba(255,255,255,0.08);
        }

        .filter-category h3 {
            margin: 0 0 12px 0;
            font-size: 14px;
            color: #ffffff;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            text-align: center;
        }

        .filter-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            justify-content: center;
        }

        .filter-button {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 10px 16px;
            background: rgba(255,255,255,0.18);
            border: 2px solid rgba(255,255,255,0.2);
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            color: #ffffff;
            transition: all 0.2s;
            user-select: none;
            min-width: 150px;
            justify-content: center;
        }

        .filter-button.wide {
            min-width: 190px;
        }

        .filter-button:hover {
            background: rgba(255,255,255,0.28);
            border-color: rgba(255,255,255,0.35);
        }

        .filter-button.active {
            background: #ffffff;
            border-color: #ffffff;
            color: #1E52BA;
        }

        .filter-button .count {
            font-size: 11px;
            background: rgba(255,255,255,0.2);
            padding: 2px 6px;
            border-radius: 10px;
        }

        .filter-button.active .count {
            background: rgba(30, 82, 186, 0.1);
            color: #1E52BA;
        }

        #active-filters {
            padding: 15px 20px;
            border-top: 1px solid rgba(255,255,255,0.2);
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: #ffffff;
            gap: 10px;
            position: sticky;
            bottom: 0;
            background: #1E52BA;
        }

        #reset-filters,
        #apply-filters {
            flex: 1;
            background: rgba(255,255,255,0.15);
            border: 1px solid rgba(255,255,255,0.4);
            color: #ffffff;
            padding: 10px 12px;
            border-radius: 18px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 700;
            transition: all 0.2s;
        }

        #apply-filters {
            background: #ffffff;
            color: #1E52BA;
            border-color: #ffffff;
        }

        #reset-filters:hover {
            background: rgba(255,255,255,0.25);
        }

        #apply-filters:hover {
            opacity: 0.9;
        }

        #map {
            flex: 1;
            height: 100%;
            width: 100%;
        }

        #main-view {
            position: relative;
            flex: 1;
            min-height: 0;
            background: #f7f5f1;
        }

        .view-panel {
            position: absolute;
            inset: 0;
        }

        .view-panel.hidden {
            display: none;
        }

        #list-view {
            overflow-y: auto;
            padding: 16px 16px 120px;
        }

        .venue-list {
            display: flex;
            flex-direction: column;
            gap: 14px;
        }

        .venue-card {
            background: #ffffff;
            border-radius: 16px;
            border: 1px solid #ebe7e0;
            padding: 14px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.04);
            display: flex;
            flex-direction: column;
            gap: 10px;
            cursor: pointer;
        }

        .venue-card-image {
            width: 100%;
            height: 150px;
            border-radius: 12px;
            object-fit: cover;
            background: #f0ebe4;
        }

        .venue-card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
        }

        .venue-card-title {
            margin: 0;
            font-size: 16px;
            font-weight: 700;
            color: #1c1b19;
        }

        .venue-card-meta {
            font-size: 12px;
            color: #6f6b65;
            font-weight: 600;
        }

        .venue-card-address {
            font-size: 12px;
            color: #7b7873;
        }

        .venue-card-description {
            font-size: 13px;
            color: #3b3834;
        }

        .venue-card-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }

        .venue-card-tag {
            padding: 4px 8px;
            border-radius: 999px;
            background: #f0ebe4;
            font-size: 11px;
            color: #4c4a45;
        }

        .venue-card-favorite {
            border: 1px solid #d8d4cd;
            background: #ffffff;
            border-radius: 999px;
            padding: 6px 10px;
            font-size: 12px;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .venue-card-favorite.active {
            background: #1E52BA;
            border-color: #1E52BA;
            color: #ffffff;
        }

        .favorite-icon {
            width: 16px;
            height: 16px;
            stroke: currentColor;
            fill: none;
            stroke-width: 2;
            flex-shrink: 0;
        }

        .favorite-icon.filled {
            fill: currentColor;
        }

        .list-empty {
            padding: 40px 20px;
            text-align: center;
            color: #66625d;
        }

        #bottom-tabs {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 64px;
            background: #ffffff;
            border-top: 1px solid #e3ded6;
            display: flex;
            align-items: center;
            justify-content: space-around;
            z-index: 1002;
        }

        .bottom-tab-button {
            border: none;
            background: transparent;
            display: inline-flex;
            flex-direction: row;
            align-items: center;
            gap: 6px;
            font-size: 12px;
            font-weight: 600;
            color: #4c4a45;
            cursor: pointer;
        }

        .bottom-tab-icon {
            width: 20px;
            height: 20px;
            display: block;
            flex-shrink: 0;
            stroke: currentColor;
            fill: none;
            stroke-width: 2.2;
        }

        .bottom-tab-button.active {
            color: #1E52BA;
        }

        .bottom-tab-badge {
            background: #BA1E1E;
            color: #ffffff;
            border-radius: 999px;
            padding: 2px 6px;
            font-size: 10px;
            min-width: 18px;
            text-align: center;
        }

        /* Full-screen venue profile view */
        #detail-modal {
            position: fixed;
            inset: 0;
            background: #f0ebe4;
            display: none;
            flex-direction: column;
            z-index: 1010;
            transform: translateX(100%);
            transition: transform 0.35s cubic-bezier(0.4, 0, 0.2, 1);
        }

        #detail-modal.active {
            display: flex;
            transform: translateX(0);
        }

        #detail-modal.entering {
            display: flex;
        }

        .detail-modal-card {
            width: 100%;
            height: 100%;
            background: transparent;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            min-height: 0;
        }

        /* Back button */
        .detail-back-button {
            position: absolute;
            top: 16px;
            left: 16px;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: rgba(0, 0, 0, 0.5);
            border: none;
            cursor: pointer;
            z-index: 20;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
            backdrop-filter: blur(4px);
            -webkit-backdrop-filter: blur(4px);
        }

        .detail-back-button:hover {
            background: rgba(0, 0, 0, 0.7);
        }

        .detail-back-button svg {
            width: 20px;
            height: 20px;
            stroke: white;
            stroke-width: 2.5;
            fill: none;
        }

        /* Hero image section */
        .detail-hero {
            position: relative;
            width: 100%;
            height: 45vh;
            min-height: 280px;
            max-height: 420px;
            flex-shrink: 0;
            background: #f0ebe4;
        }

        .detail-hero .venue-slider {
            position: absolute;
            inset: 0;
            margin: 0;
            border-radius: 0;
            overflow: hidden;
        }

        .detail-hero .slider-container {
            height: 100%;
        }

        .detail-hero .venue-slider img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .detail-hero .slider-arrow {
            width: 36px;
            height: 36px;
            font-size: 18px;
        }

        .detail-hero .slider-arrow.prev {
            left: 16px;
        }

        .detail-hero .slider-arrow.next {
            right: 16px;
        }

        .detail-hero .slider-dots {
            bottom: 70px;
        }

        .detail-hero .slider-dot {
            width: 10px;
            height: 10px;
        }

        /* Gradient overlay for text */
        .detail-hero-overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 60px 20px 16px;
            background: linear-gradient(to top, rgba(0,0,0,0.75) 0%, rgba(0,0,0,0.4) 50%, transparent 100%);
            display: flex;
            align-items: flex-end;
            justify-content: space-between;
            gap: 12px;
        }

        .detail-hero-info {
            flex: 1;
            min-width: 0;
        }

        .detail-hero-name {
            margin: 0 0 4px;
            font-size: 24px;
            font-weight: 700;
            color: white;
            text-shadow: 0 1px 4px rgba(0,0,0,0.3);
            line-height: 1.2;
        }

        .detail-hero-address {
            margin: 0;
            font-size: 14px;
            color: rgba(255,255,255,0.9);
            text-shadow: 0 1px 2px rgba(0,0,0,0.3);
        }

        /* Favorite heart button on hero */
        .detail-favorite-btn {
            flex-shrink: 0;
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background: rgba(255,255,255,0.95);
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 22px;
            color: #888;
            transition: all 0.2s;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }

        .detail-favorite-btn .favorite-icon {
            width: 20px;
            height: 20px;
        }

        .detail-favorite-btn:hover {
            transform: scale(1.1);
        }

        .detail-favorite-btn.active {
            color: #1E52BA;
        }

        /* Content section below image */
        .detail-content {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background: #ffffff;
            -webkit-overflow-scrolling: touch;
            border-radius: 24px 24px 0 0;
            position: relative;
            z-index: 1;
            margin-top: 12px;
            min-height: 0;
        }

        .detail-section {
            margin-bottom: 20px;
        }

        .detail-section:last-child {
            margin-bottom: 0;
        }

        /* Contact info links */
        .detail-contact-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .detail-contact-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 14px;
            background: #f8f9fa;
            border-radius: 12px;
            text-decoration: none;
            color: #333;
            font-size: 14px;
            transition: background 0.2s;
        }

        .detail-contact-item:hover {
            background: #f0f1f3;
        }

        .detail-contact-icon {
            flex-shrink: 0;
            width: 20px;
            text-align: center;
            font-size: 16px;
        }

        .detail-contact-text {
            flex: 1;
            min-width: 0;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .detail-contact-item.clickable {
            color: #1E52BA;
            cursor: pointer;
        }

        .detail-contact-item.clickable:hover {
            background: #e8f0fe;
        }

        .detail-contact-arrow {
            color: #999;
            font-size: 14px;
        }

        /* Description */
        .detail-description {
            font-size: 15px;
            line-height: 1.6;
            color: #333;
        }

        /* Info rows (hours, specialty) */
        .detail-info-row {
            display: flex;
            gap: 8px;
            padding: 10px 0;
            border-bottom: 1px solid #eee;
            font-size: 14px;
        }

        .detail-info-row:last-child {
            border-bottom: none;
        }

        .detail-info-label {
            flex-shrink: 0;
            font-weight: 600;
            color: #666;
            min-width: 80px;
        }

        .detail-info-value {
            color: #333;
        }

        .detail-info-value.seasonal {
            color: #BA1E1E;
            font-weight: 600;
        }

        /* Filter tags */
        .detail-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .detail-tag {
            display: inline-flex;
            align-items: center;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
            color: white;
        }

        .detail-tag.venueType { background: #3b82f6; }
        .detail-tag.cuisineType { background: #10b981; }
        .detail-tag.ageRange { background: #f59e0b; }
        .detail-tag.amenities { background: #8b5cf6; }

        .detail-section-title {
            margin: 0 0 12px;
            font-size: 13px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: #888;
        }

        /* Safe area for notched devices */
        @supports (padding-top: env(safe-area-inset-top)) {
            .detail-back-button {
                top: calc(16px + env(safe-area-inset-top));
            }

            .detail-content {
                padding-bottom: calc(20px + env(safe-area-inset-bottom));
            }
        }

        /* Desktop styling for detail modal */
        @media (min-width: 769px) {
            #detail-modal {
                background: rgba(0, 0, 0, 0.5);
                display: none;
                align-items: center;
                justify-content: center;
                transform: none;
                opacity: 0;
                transition: opacity 0.3s ease;
            }

            #detail-modal.active {
                display: flex;
                opacity: 1;
            }

            #detail-modal.entering {
                display: flex;
                opacity: 0;
            }

            .detail-modal-card {
                width: min(520px, 90vw);
                max-height: 90vh;
                border-radius: 16px;
                overflow: hidden;
                box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
                transform: scale(0.95);
                transition: transform 0.3s ease;
            }

            #detail-modal.active .detail-modal-card {
                transform: scale(1);
            }

            .detail-hero {
                height: 35vh;
                min-height: 220px;
                max-height: 320px;
            }

            .detail-back-button {
                top: 12px;
                left: 12px;
            }
        }

        #toggle-sidebar {
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 1001;
            background: white;
            border: 2px solid rgba(0,0,0,0.2);
            border-radius: 4px;
            padding: 8px 12px;
            cursor: pointer;
            font-size: 18px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
            display: none;
        }

        .leaflet-popup-content h3 {
            margin-top: 0;
            color: #1E52BA;
        }

        .venue-tags {
            margin-top: 10px;
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
        }

        .venue-tag {
            background: #e9ecef;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 11px;
            color: #495057;
        }

        /* Mobile responsive */
        @media (max-width: 768px) {
            body {
                overflow-y: auto;
            }

            #container {
                flex-direction: column;
                min-height: 100dvh;
            }

            #sidebar {
                position: fixed;
                left: 0;
                right: 0;
                top: 168px;
                bottom: 0;
                width: 100%;
                max-height: none;
                transform: translateY(100%);
                box-shadow: 0 -4px 12px rgba(0,0,0,0.15);
                border-radius: 16px 16px 0 0;
                transition: transform 0.3s ease;
                padding-top: 12px;
                padding-bottom: 20px;
                z-index: 1006;
                opacity: 0;
                visibility: hidden;
                pointer-events: none;
            }

            #sidebar.show {
                transform: translateY(0);
                opacity: 1;
                visibility: visible;
                pointer-events: auto;
            }

            #filters-container {
                max-height: none;
                padding-top: 10px;
            }

            #active-filters {
                position: sticky;
                bottom: 0;
                background: #1E52BA;
            }

            #map {
                height: 100%;
                min-height: 50dvh;
            }

            #toggle-sidebar {
                display: none !important;
            }

            #app-header {
                padding: 12px 16px;
                position: relative;
                justify-content: center;
            }

            #app-title {
                font-size: 17px;
            }

            #brand {
                gap: 10px;
                margin: 0 auto;
                max-width: calc(100% - 88px);
                justify-content: center;
            }

            #brand-logo-wrap {
                padding: 5px 8px;
                border-radius: 10px;
            }

            #brand-logo {
                height: 28px;
                max-width: 100%;
            }

            body {
                font-size: 16px;
            }

            #top-search-input,
            #search-input {
                font-size: 15px;
            }

            .filter-category h3 {
                font-size: 15px;
            }

            .filter-button {
                font-size: 15px;
                padding: 12px 18px;
            }

            .tab-button {
                font-size: 14px;
            }

            .venue-card-title {
                font-size: 17px;
            }

            .venue-card-meta,
            .venue-card-address {
                font-size: 13px;
            }

            .venue-card-description {
                font-size: 14px;
            }

            .venue-card-tag {
                font-size: 12px;
            }

            .venue-card-favorite {
                font-size: 13px;
            }

            .bottom-tab-button {
                font-size: 14px;
            }

            .menu-button {
                font-size: 15px;
            }

            .fullscreen-body,
            .fullscreen-body p {
                font-size: 15px;
            }

            .suggest-form label {
                font-size: 13px;
            }

            .suggest-form input,
            .suggest-form textarea {
                font-size: 15px;
            }

            .suggest-submit {
                font-size: 15px;
            }

        }

        /* Custom scrollbar */
        #filters-container::-webkit-scrollbar {
            width: 6px;
        }

        #filters-container::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        #filters-container::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 3px;
        }

        #filters-container::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        /* Marker cluster styling */
        .marker-cluster-small,
        .marker-cluster-medium,
        .marker-cluster-large {
            background: #1E52BA;
        }

        .marker-cluster-small div,
        .marker-cluster-medium div,
        .marker-cluster-large div {
            background: #1E52BA;
            color: white;
            font-weight: bold;
        }

        .marker-cluster {
            background-clip: padding-box;
        }

        /* Image slider styles */
        .venue-slider {
            position: relative;
            width: 100%;
            margin-bottom: 10px;
            overflow: hidden;
            border-radius: 8px;
        }

        .venue-slider img {
            width: 100%;
            height: 150px;
            object-fit: cover;
            display: block;
            flex-shrink: 0;
            flex: 0 0 100%;
            scroll-snap-align: center;
            scroll-snap-stop: always;
            background: #f5f5f5;
        }

        .slider-container {
            display: flex;
            width: auto;
            min-width: 100%;
            overflow-x: auto;
            scroll-snap-type: x mandatory;
            scroll-behavior: smooth;
        }

        .slider-arrow {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(255, 255, 255, 0.9);
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            cursor: pointer;
            font-size: 16px;
            z-index: 10;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .slider-arrow:hover {
            background: white;
        }

        .slider-arrow.prev {
            left: 5px;
        }

        .slider-arrow.next {
            right: 5px;
        }

        .slider-dots {
            text-align: center;
            padding: 5px 0;
            position: absolute;
            bottom: 5px;
            width: 100%;
        }

        .slider-dot {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.5);
            margin: 0 3px;
        }

        .slider-dot.active {
            background: white;
        }

        /* Popup sizing */
        .custom-popup .leaflet-popup-content-wrapper {
            max-width: 340px;
            width: clamp(260px, 70vw, 340px);
        }

        .custom-popup .leaflet-popup-content {
            margin: 8px 10px;
            max-height: 320px;
            overflow-y: auto;
            overflow-x: hidden;
        }

        .favorite-toggle {
            border: none;
            background: #f2f4fb;
            color: #1E52BA;
            border-radius: 18px;
            padding: 6px 10px;
            font-size: 12px;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .favorite-toggle.active {
            background: #1E52BA;
            color: white;
        }

        .favorite-toggle .favorite-icon {
            width: 16px;
            height: 16px;
        }

        .install-banner {
            position: sticky;
            top: 0;
            z-index: 1003;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            padding: 10px 16px;
            background: #1E52BA;
            color: white;
            font-size: 13px;
        }

        .install-banner.hidden {
            display: none;
        }

        .install-banner button {
            background: white;
            color: #1E52BA;
            border: none;
            border-radius: 16px;
            padding: 6px 12px;
            font-size: 12px;
            cursor: pointer;
        }

        /* Top Search Bar - Always visible */
        #top-search-bar {
            background: white;
            padding: 12px 20px;
            display: flex;
            align-items: center;
            gap: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        #top-search-container {
            flex: 1;
            max-width: 600px;
            position: relative;
        }

        #top-search-input {
            width: 100%;
            padding: 14px 48px 14px 20px;
            border: 1px solid #e0e0e0;
            border-radius: 28px;
            font-size: 15px;
            background: #f8f9fa;
            color: #333;
            outline: none;
            transition: background 0.2s, box-shadow 0.2s, border-color 0.2s;
        }

        #top-search-input:focus {
            background: #fff;
            border-color: #1E52BA;
            box-shadow: 0 2px 8px rgba(30,82,186,0.15);
        }

        #top-search-input::placeholder {
            color: #888;
        }

        #top-search-input:focus {
            background: #4a4a4a;
            box-shadow: 0 0 0 2px rgba(30, 82, 186, 0.5);
        }

        #top-search-icon {
            position: absolute;
            right: 16px;
            top: 50%;
            transform: translateY(-50%);
            color: #1E52BA;
            pointer-events: none;
        }

        #top-search-dropdown {
            position: absolute;
            top: calc(100% + 8px);
            left: 0;
            right: 0;
            background: white;
            border-radius: 16px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.2);
            max-height: 280px;
            overflow-y: auto;
            display: none;
            z-index: 1010;
        }

        #top-search-dropdown.show {
            display: block;
        }

        .top-search-dropdown-item {
            padding: 14px 18px;
            cursor: pointer;
            border-bottom: 1px solid #f0f0f0;
            font-size: 14px;
            color: #333;
        }

        .top-search-dropdown-item:last-child {
            border-bottom: none;
        }

        .top-search-dropdown-item:hover {
            background: #f8f9fa;
        }

        .top-search-dropdown-item strong {
            color: #1E52BA;
        }

        .top-search-dropdown-item .city-label {
            color: #888;
            font-size: 13px;
        }

        /* Quick filter pills row */
        #quick-filters-row {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 20px;
            background: white;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }

        #quick-filters-row::-webkit-scrollbar {
            display: none;
        }

        .quick-filter-pill {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 8px 14px;
            background: #f0f0f0;
            border: none;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 500;
            color: #444;
            cursor: pointer;
            white-space: nowrap;
            flex-shrink: 0;
            transition: background 0.2s, color 0.2s;
        }

        .quick-filter-pill:hover {
            background: #e5e5e5;
        }

        .quick-filter-pill.active {
            background: #1E52BA;
            color: white;
        }

        .quick-filter-pill svg {
            width: 16px;
            height: 16px;
            flex-shrink: 0;
        }

        .quick-filter-heart {
            width: 18px;
            height: 18px;
            stroke: currentColor;
        }

        .quick-filter-pill.active svg {
            stroke: white;
        }

        /* Hide sidebar search on mobile since top bar is primary */
        @media (max-width: 768px) {
            #search-container {
                display: none;
            }

            #top-search-bar {
                padding: 10px 16px;
            }

            #top-search-input {
                padding: 12px 44px 12px 16px;
                font-size: 15px;
            }

            #quick-filters-row {
                padding: 8px 16px;
            }

            .quick-filter-pill {
                padding: 8px 14px;
                font-size: 14px;
            }
        }
    </style>
</head>
<body>
    <div id="install-banner" class="install-banner hidden">
        <span id="install-banner-text">Install Friendly Spaces for quick access.</span>
        <button id="install-button">Add to Home Screen</button>
    </div>
    <header id="app-header">
        <div id="brand">
            <span id="brand-logo-wrap">
                <img id="brand-logo" src="assets/FriendlySpaces_white.png" alt="Friendly Spaces">
            </span>
            <h1 id="app-title">Friendly Spaces</h1>
        </div>
        <button id="menu-toggle" type="button" aria-label="Open menu">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                <line x1="4" y1="6" x2="20" y2="6"></line>
                <line x1="4" y1="12" x2="20" y2="12"></line>
                <line x1="4" y1="18" x2="20" y2="18"></line>
            </svg>
        </button>
    </header>
    <div id="top-search-bar">
        <div id="top-search-container">
            <input type="text" id="top-search-input" placeholder="Search by name, city, or address...">
            <span id="top-search-icon" aria-hidden="true">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="11" cy="11" r="7"></circle>
                    <line x1="16.65" y1="16.65" x2="21" y2="21"></line>
                </svg>
            </span>
            <div id="top-search-dropdown"></div>
        </div>
    </div>
    <div id="quick-filters-row">
        <button class="quick-filter-pill" id="pill-filters" type="button">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <line x1="4" y1="6" x2="20" y2="6"></line>
                <line x1="4" y1="12" x2="20" y2="12"></line>
                <line x1="4" y1="18" x2="20" y2="18"></line>
                <circle cx="8" cy="6" r="2" fill="currentColor"></circle>
                <circle cx="16" cy="12" r="2" fill="currentColor"></circle>
                <circle cx="10" cy="18" r="2" fill="currentColor"></circle>
            </svg>
            <span data-pill-label="filters">Filters</span>
        </button>
        <button class="quick-filter-pill" id="pill-favorites" type="button" aria-label="Favorites">
            <svg class="quick-filter-heart" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                <path d="M20.8 6.6c-1.4-1.4-3.8-1.4-5.2 0L12 10.2 8.4 6.6C7 5.2 4.6 5.2 3.2 6.6c-1.4 1.4-1.4 3.8 0 5.2L12 21l8.8-9.2c1.4-1.4 1.4-3.8 0-5.2z"></path>
            </svg>
        </button>
        <button class="quick-filter-pill" id="pill-cafe" data-filter-category="venueType" data-filter-value="cafe" type="button">
            <span data-pill-label="cafe">Cafe</span>
        </button>
        <button class="quick-filter-pill" id="pill-baby" data-filter-category="ageRange" data-filter-value="baby" type="button">
            <span data-pill-label="baby">Baby</span>
        </button>
        <button class="quick-filter-pill" id="pill-toddler" data-filter-category="ageRange" data-filter-value="toddler" type="button">
            <span data-pill-label="toddler">Toddler</span>
        </button>
        <button class="quick-filter-pill" id="pill-play-area" data-filter-category="amenities" data-filter-value="play-area" type="button">
            <span data-pill-label="play-area">Play Area</span>
        </button>
    </div>
    <div id="sheet-backdrop"></div>
    <div id="container">
        <aside id="sidebar">
            <div id="drag-handle"></div>
            <div id="sidebar-header">
                <h2 id="sidebar-title">Find a Friendly Space</h2>
                <div id="search-container">
                    <input type="text" id="search-input" placeholder="Search by name, city, or address...">
                    <span id="search-icon" aria-hidden="true">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#1E52BA" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="11" cy="11" r="7"></circle>
                            <line x1="16.65" y1="16.65" x2="21" y2="21"></line>
                        </svg>
                    </span>
                    <div id="search-dropdown"></div>
                </div>
            </div>
            <div id="sidebar-actions">
                <button id="sidebar-favorites" class="filter-button" type="button">
                    <svg class="favorite-icon" viewBox="0 0 24 24" aria-hidden="true">
                        <path d="M20.8 6.6c-1.4-1.4-3.8-1.4-5.2 0L12 10.2 8.4 6.6C7 5.2 4.6 5.2 3.2 6.6c-1.4 1.4-1.4 3.8 0 5.2L12 21l8.8-9.2c1.4-1.4 1.4-3.8 0-5.2z"></path>
                    </svg>
                    <span id="sidebar-favorites-label">Favorites</span>
                </button>
            </div>

            <div id="filters-container">
                <div class="filter-category">
                    <h3 data-category-heading="venueType">Venue Type</h3>
                    <div class="filter-buttons" id="venueType-filters"></div>
                </div>

                <div class="filter-category">
                    <h3 data-category-heading="cuisineType">Cuisine Type</h3>
                    <div class="filter-buttons" id="cuisineType-filters"></div>
                </div>

                <div class="filter-category">
                    <h3 data-category-heading="ageRange">Age Range</h3>
                    <div class="filter-buttons" id="ageRange-filters"></div>
                </div>

                <div class="filter-category">
                    <h3 data-category-heading="amenities">Amenities</h3>
                    <div class="filter-buttons" id="amenities-filters"></div>
                </div>
            </div>

            <div id="active-filters">
                <button id="reset-filters" type="button">Reset all filters</button>
                <button id="apply-filters" type="button">Show all spaces</button>
            </div>
        </aside>

        <div id="main-view">
            <button id="toggle-sidebar">☰</button>
            <div id="map" class="view-panel"></div>
            <div id="list-view" class="view-panel hidden">
                <div id="list-cards" class="venue-list"></div>
                <div id="list-empty" class="list-empty" hidden>No venues found.</div>
            </div>
        </div>
    </div>
    <div id="menu-backdrop" aria-hidden="true"></div>
    <aside id="menu-drawer" aria-label="App menu">
        <div id="menu-header">
            <h2 id="menu-title">Menu</h2>
            <button id="menu-close" type="button" aria-label="Close menu">Close</button>
        </div>
        <button class="menu-button" id="menu-suggest" type="button">
            Suggest a venue
            <span aria-hidden="true">›</span>
        </button>
        <button class="menu-button" id="menu-share" type="button">
            Share the app
            <span aria-hidden="true">↗</span>
        </button>
        <button class="menu-button" id="menu-about" type="button">
            About us
            <span aria-hidden="true">›</span>
        </button>
        <p class="menu-section-title">Language</p>
        <div id="language-toggle" aria-label="Language switcher">
            <button type="button" data-lang="de">DE</button>
            <button type="button" data-lang="fr">FR</button>
            <button type="button" data-lang="en">EN</button>
        </div>
    </aside>
    <section id="suggest-view" class="fullscreen-panel" aria-hidden="true">
        <div class="fullscreen-header">
            <h2 class="fullscreen-title">Suggest a venue</h2>
            <button class="fullscreen-close" type="button" id="suggest-close">Close</button>
        </div>
        <div class="fullscreen-body">
            <div class="suggest-toggle" role="group" aria-label="Your role">
                <button type="button" class="active" data-suggest-role="owner">I am a venue owner</button>
                <button type="button" data-suggest-role="fan">I am a Friendly Spaces enthusiast</button>
            </div>
            <form id="suggest-form" class="suggest-form">
                <div>
                    <label for="venue-name">Venue name</label>
                    <input id="venue-name" name="venueName" required>
                </div>
                <div>
                    <label for="venue-city">City</label>
                    <input id="venue-city" name="venueCity" required>
                </div>
                <div>
                    <label for="venue-why">Why is it friendly? (optional)</label>
                    <textarea id="venue-why" name="venueWhy"></textarea>
                </div>
                <div id="owner-fields">
                    <div>
                        <label for="owner-name">Your name</label>
                        <input id="owner-name" name="ownerName">
                    </div>
                    <div>
                        <label for="owner-email">Your email</label>
                        <input id="owner-email" name="ownerEmail" type="email">
                    </div>
                    <div>
                        <label for="owner-phone">Phone (optional)</label>
                        <input id="owner-phone" name="ownerPhone" type="tel">
                    </div>
                </div>
                <button class="suggest-submit" type="submit">Send suggestion</button>
            </form>
        </div>
    </section>
    <section id="about-view" class="fullscreen-panel" aria-hidden="true">
        <div class="fullscreen-header">
            <h2 class="fullscreen-title">About us</h2>
            <button class="fullscreen-close" type="button" id="about-close">Close</button>
        </div>
        <div class="fullscreen-body">
            <p>Lorem ipsum dolor sit amet, consectetur adipiscing elit. Sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat.</p>
            <p>Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.</p>
        </div>
    </section>
    <nav id="bottom-tabs" aria-label="Primary">
        <button class="bottom-tab-button active" data-view="map" id="bottom-tab-map" type="button">
            <span>Map</span>
            <svg class="bottom-tab-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                <polygon points="1 6 8 3 16 6 23 3 23 18 16 21 8 18 1 21"></polygon>
                <line x1="8" y1="3" x2="8" y2="18"></line>
                <line x1="16" y1="6" x2="16" y2="21"></line>
            </svg>
        </button>
        <button class="bottom-tab-button" data-view="list" id="bottom-tab-list" type="button">
            <span>List</span>
            <svg class="bottom-tab-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                <line x1="8" y1="6" x2="21" y2="6"></line>
                <line x1="8" y1="12" x2="21" y2="12"></line>
                <line x1="8" y1="18" x2="21" y2="18"></line>
                <circle cx="4" cy="6" r="1"></circle>
                <circle cx="4" cy="12" r="1"></circle>
                <circle cx="4" cy="18" r="1"></circle>
            </svg>
        </button>
    </nav>
    <div id="detail-modal" role="dialog" aria-modal="true" aria-hidden="true">
        <div class="detail-modal-card">
            <button class="detail-back-button" id="detail-modal-close" type="button" aria-label="Go back">
                <svg viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round">
                    <polyline points="15 18 9 12 15 6"></polyline>
                </svg>
            </button>
            <div id="detail-modal-content"></div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
    <script>
        // Language support (German/French) with query param override (?lang=de|fr)
        const supportedLanguages = ['de', 'fr', 'en'];
        const translations = {
            de: {
                ui: {
                    title: "Friendly Spaces",
                    sidebarTitle: "Einen Friendly Space finden",
                    searchPlaceholder: "Nach Name, Stadt oder Adresse suchen...",
                    languageLabel: "Sprache",
                    showingLabel: "Zeige",
                    venuesLabel: "Orte",
                    filtersLabel: "Filter",
                    clearFilters: "Alle löschen",
                    showAllSpaces: "Alle Orte anzeigen",
                    showSpaces: "Zeige",
                    spacesLabel: "Orte",
                    allTab: "Alle",
                    favoritesTab: "Favoriten",
                    mapTab: "Karte",
                    listTab: "Liste",
                    noVenuesTitle: "Keine Orte gefunden",
                    noVenuesBody: "Versuche andere Filter oder eine neue Suche.",
                    noFavoritesTitle: "Noch keine Favoriten",
                    noFavoritesBody: "Tippe auf das Herz, um Orte zu speichern.",
                    favoritesInstall: "Friendly Spaces installieren",
                    favoritesInstallCta: "Zum Homescreen",
                    favoriteAdd: "Merken",
                    favoriteRemove: "Gespeichert",
                    filtersActive: (count) => count === 1 ? "1 Filter aktiv" : `${count} Filter aktiv`,
                    filtersButton: (count) => count > 0 ? `Filter (${count})` : "Filter",
                    cityCount: (count) => count === 1 ? "1 Ort" : `${count} Orte`,
                },
                filters: {
                    categories: {
                        venueType: "Ortstyp",
                        cuisineType: "Küche",
                        ageRange: "Altersgruppe",
                        amenities: "Ausstattung"
                    },
                    options: {
                        venueType: {
                            cafe: "Café",
                            "craft-atelier": "Kreativ-Atelier",
                            "food-hall": "Food Hall"
                        },
                        cuisineType: {
                            vegan: "Vegan",
                            bistro: "Bistro",
                            patisserie: "Patisserie",
                            international: "International"
                        },
                        ageRange: {
                            baby: "Baby (0-1)",
                            toddler: "Kleinkind (2-3)",
                            "small-child": "Kind (4-6)",
                            kid: "Schulkind (7-12)"
                        },
                        amenities: {
                            playground: "Spielplatz",
                            "outdoor-seating": "Aussensitzplätze",
                            "play-area": "Spielbereich",
                            "friendly-spaces": "Friendly Spaces Playbox",
                            "high-chair": "Kinderstuhl",
                            "change-table": "Wickeltisch",
                            "games-room": "Spielzimmer"
                        }
                    }
                },
                popup: {
                    visitWebsite: "Webseite besuchen",
                    hours: "Öffnungszeiten",
                    specialty: "Besonderheit",
                    directions: "Route planen",
                    viewProfile: "Profil anzeigen",
                    features: "Ausstattung"
                }
            },
            fr: {
                ui: {
                    title: "Friendly Spaces",
                    sidebarTitle: "Trouver un Friendly Space",
                    searchPlaceholder: "Rechercher par nom, ville ou adresse...",
                    languageLabel: "Langue",
                    showingLabel: "Afficher",
                    venuesLabel: "lieux",
                    filtersLabel: "Filtres",
                    clearFilters: "Tout effacer",
                    showAllSpaces: "Afficher tous les lieux",
                    showSpaces: "Afficher",
                    spacesLabel: "lieux",
                    allTab: "Tous",
                    favoritesTab: "Favoris",
                    mapTab: "Carte",
                    listTab: "Liste",
                    noVenuesTitle: "Aucun lieu trouvé",
                    noVenuesBody: "Essayez d'autres filtres ou une nouvelle recherche.",
                    noFavoritesTitle: "Pas encore de favoris",
                    noFavoritesBody: "Touchez le cœur pour enregistrer.",
                    favoritesInstall: "Installer Friendly Spaces",
                    favoritesInstallCta: "Ajouter à l'écran",
                    favoriteAdd: "Enregistrer",
                    favoriteRemove: "Enregistré",
                    filtersActive: (count) => count === 1 ? "1 filtre actif" : `${count} filtres actifs`,
                    filtersButton: (count) => count > 0 ? `Filtres (${count})` : "Filtres",
                    cityCount: (count) => count === 1 ? "1 lieu" : `${count} lieux`,
                },
                filters: {
                    categories: {
                        venueType: "Type de lieu",
                        cuisineType: "Type de cuisine",
                        ageRange: "Tranche d'âge",
                        amenities: "Équipements"
                    },
                    options: {
                        venueType: {
                            cafe: "Café",
                            "craft-atelier": "Atelier créatif",
                            "food-hall": "Food Hall"
                        },
                        cuisineType: {
                            vegan: "Végane",
                            bistro: "Bistrot",
                            patisserie: "Pâtisserie",
                            international: "Cuisine internationale"
                        },
                        ageRange: {
                            baby: "Bébé (0-1)",
                            toddler: "Tout-petit (2-3)",
                            "small-child": "Jeune enfant (4-6)",
                            kid: "Enfant (7-12)"
                        },
                        amenities: {
                            playground: "Terrain de jeu",
                            "outdoor-seating": "Terrasse extérieure",
                            "play-area": "Aire de jeux",
                            "friendly-spaces": "Friendly Spaces Playbox",
                            "high-chair": "Chaise haute",
                            "change-table": "Table à langer",
                            "games-room": "Salle de jeux"
                        }
                    }
                },
                popup: {
                    visitWebsite: "Visiter le site",
                    hours: "Horaires",
                    specialty: "Spécialité",
                    directions: "Itinéraire",
                    viewProfile: "Voir le profil",
                    features: "Équipements"
                }
            },
            en: {
                ui: {
                    title: "Friendly Spaces",
                    sidebarTitle: "Find a Friendly Space",
                    searchPlaceholder: "Search by name, city, or address...",
                    languageLabel: "Language",
                    showingLabel: "Showing",
                    venuesLabel: "venues",
                    filtersLabel: "Filters",
                    clearFilters: "Clear All",
                    showAllSpaces: "Show all spaces",
                    showSpaces: "Show",
                    spacesLabel: "spaces",
                    allTab: "All",
                    favoritesTab: "Favorites",
                    mapTab: "Map",
                    listTab: "List",
                    noVenuesTitle: "No venues found",
                    noVenuesBody: "Try clearing filters or searching another city.",
                    noFavoritesTitle: "No favorites yet",
                    noFavoritesBody: "Tap the heart to save places.",
                    favoritesInstall: "Install Friendly Spaces",
                    favoritesInstallCta: "Add to Home Screen",
                    favoriteAdd: "Save",
                    favoriteRemove: "Saved",
                    filtersActive: (count) => count === 1 ? "1 filter active" : `${count} filters active`,
                    filtersButton: (count) => count > 0 ? `Filters (${count})` : "Filters",
                    cityCount: (count) => count === 1 ? "1 venue" : `${count} venues`,
                },
                filters: {
                    categories: {
                        venueType: "Venue Type",
                        cuisineType: "Cuisine Type",
                        ageRange: "Age Range",
                        amenities: "Amenities"
                    },
                    options: {
                        venueType: {
                            cafe: "Cafe",
                            "craft-atelier": "Creative Atelier",
                            "food-hall": "Food Hall"
                        },
                        cuisineType: {
                            vegan: "Vegan",
                            bistro: "Bistro",
                            patisserie: "Patisserie",
                            international: "International"
                        },
                        ageRange: {
                            baby: "Baby (0-1)",
                            toddler: "Toddler (2-3)",
                            "small-child": "Small Child (4-6)",
                            kid: "Kid (7-12)"
                        },
                        amenities: {
                            playground: "Playground",
                            "outdoor-seating": "Outdoor Seating",
                            "play-area": "Play Area",
                            "friendly-spaces": "Friendly Spaces Playbox",
                            "high-chair": "High Chair",
                            "change-table": "Change Table",
                            "games-room": "Games Room"
                        }
                    }
                },
                popup: {
                    visitWebsite: "Visit Website",
                    hours: "Hours",
                    specialty: "Specialty",
                    directions: "Directions",
                    viewProfile: "View Full Profile",
                    features: "Features"
                }
            }
        };

        const languageKey = 'friendlyspaces_lang';
        let currentLang = getPreferredLanguage();

        function getPreferredLanguage() {
            const params = new URLSearchParams(window.location.search);
            const fromQuery = params.get('lang')?.toLowerCase();
            if (fromQuery && supportedLanguages.includes(fromQuery)) return fromQuery;

            try {
                const stored = localStorage.getItem(languageKey);
                if (stored && supportedLanguages.includes(stored)) {
                    return stored;
                }
            } catch (err) {
                // Ignore storage issues and fall back to browser language.
            }

            const browser = (navigator.language || navigator.userLanguage || '').slice(0, 2).toLowerCase();
            if (supportedLanguages.includes(browser)) return browser;

            return 'de'; // default to German
        }

        document.documentElement.lang = currentLang;

        function translate(path, fallback) {
            const segments = path.split('.');
            const value =
                segments.reduce((obj, key) => obj?.[key], translations[currentLang]) ??
                segments.reduce((obj, key) => obj?.[key], translations['de']);
            return value !== undefined ? value : fallback;
        }

        function formatPhoneHref(phone) {
            if (!phone) return null;
            if (/contact via website/i.test(phone)) return null;
            const normalized = phone.replace(/[^+\d]/g, '');
            if (!normalized || normalized.replace(/\D/g, '').length === 0) return null;
            return `tel:${normalized}`;
        }

        // Helper to get localized venue text fields
        function getVenueText(venue, field) {
            const localized = venue.i18n?.[field];
            if (localized && typeof localized === 'object') {
                return localized[currentLang] ||
                    venue[field] ||
                    localized['en'] ||
                    localized['de'] ||
                    '';
            }
            return venue[field] || '';
        }

        // Venue data with filter tags
        const venues = [
            {
                name: "Orangerie Elfenau",
                address: "Elfenauweg 92, 3006 Bern",
                city: "Bern",
                description: "Elegant cafe and bistro in a historic orangery surrounded by beautiful gardens",
                i18n: {
                    description: {
                        de: "Elegantes Café und Bistro in einer historischen Orangerie mit Gartenambiente",
                        fr: "Café-bistro élégant dans une orangerie historique entourée de jardins"
                    },
                    hours: {
                        de: "Mi-So: 11-19 Uhr (Saisonzeiten können variieren)",
                        fr: "Mer-dim : 11h-19h (horaires saisonniers variables)"
                    },
                    specialty: {
                        de: "Gartenterrasse und hausgemachte Kuchen",
                        fr: "Terrasse jardin et gâteaux maison"
                    }
                },
                hours: "Wed-Sun: 11am-7pm (seasonal hours may vary)",
                specialty: "Garden terrace and homemade cakes",
                seasonalNote: {
                    de: "Derzeit geschlossen bis April (Saisonbetrieb)",
                    fr: "Actuellement fermé jusqu'en avril (ouverture saisonnière)",
                    en: "Currently closed until April (seasonal)"
                },
                phone: "+41 31 350 16 20",
                website: "https://orangerieelfenau.ch/",
                images: [
                    "assets/bern/Orangerie_Elfenau/Orangerie_01.jpg",
                    "assets/bern/Orangerie_Elfenau/Orangerie_02.jpg",
                    "assets/bern/Orangerie_Elfenau/Orangerie_03.jpg",
                    "assets/bern/Orangerie_Elfenau/Orangerie_04.jpg",
                    "assets/bern/Orangerie_Elfenau/Orangerie_06.jpg"
                ],
                fallbackCoords: [46.9330368, 7.4659898],
                filters: {
                    venueType: ["cafe"],
                    cuisineType: ["bistro"],
                    ageRange: ["baby", "toddler", "small-child", "kid"],
                    amenities: ["outdoor-seating", "playground", "friendly-spaces", "high-chair", "change-table"]
                }
            },
            {
                name: "Love is Sweet Atelier",
                address: "Socinstrasse 2, 4051 Basel",
                city: "Basel",
                description: "Creative craft atelier offering art workshops for children including jewelry, ceramics, painting, and more",
                i18n: {
                    description: {
                        de: "Kreatives Atelier mit Kunstworkshops für Kinder, darunter Schmuck, Keramik, Malen und mehr",
                        fr: "Atelier créatif proposant des ateliers d'art pour enfants : bijoux, céramique, peinture et plus"
                    },
                    hours: {
                        de: "Workshop-Zeiten variieren – siehe Website für den Plan",
                        fr: "Horaires des ateliers variables – consulter le site pour le planning"
                    },
                    specialty: {
                        de: "Kunstworkshops und kreative Aktivitäten für Kinder",
                        fr: "Ateliers d'art et activités créatives pour enfants"
                    }
                },
                hours: "Workshop hours vary - check website for schedule",
                specialty: "Art workshops and creative activities for kids",
                phone: "Contact via website",
                website: "https://loveissweet.ch/",
                images: [
                    "assets/basel/LIS_Atelier/LIS_Atelier_01.jpg",
                    "assets/basel/LIS_Atelier/LIS_Atelier_02.jpg",
                    "assets/basel/LIS_Atelier/LIS_Atelier_03.jpg",
                    "assets/basel/LIS_Atelier/LIS_Atelier_04.jpg",
                    "assets/basel/LIS_Atelier/LIS_Atelier_05.jpg"
                ],
                fallbackCoords: [47.5580748, 7.5792603],
                filters: {
                    venueType: ["craft-atelier"],
                    cuisineType: [],
                    ageRange: ["toddler", "small-child", "kid"],
                    amenities: ["high-chair", "change-table"]
                }
            },
            {
                name: "Magical Cafe",
                address: "Max Kämpf Platz 2, 4058 Basel",
                city: "Basel",
                description: "Family-friendly cafe with homemade cupcakes, coffee, and large indoor play area for children",
                i18n: {
                    description: {
                        de: "Familienfreundliches Café mit hausgemachten Cupcakes, Kaffee und grossem Indoor-Spielbereich",
                        fr: "Café familial avec cupcakes maison, café et grande aire de jeux intérieure"
                    },
                    hours: {
                        de: "Di-Fr: 10-17 Uhr (Wochenenden für Privatfeiern reserviert)",
                        fr: "Mar-ven : 10h-17h (week-ends réservés aux fêtes privées)"
                    },
                    specialty: {
                        de: "Hausgemachte Cupcakes und thematische Geburtstagsfeiern",
                        fr: "Cupcakes maison et fêtes d'anniversaire à thème"
                    }
                },
                hours: "Tue-Fri: 10am-5pm (weekends reserved for private parties)",
                specialty: "Homemade cupcakes and themed birthday parties",
                phone: "+41 78 905 37 38",
                website: "https://magicalcafe.ch/",
                images: [
                    "assets/basel/Magical_Cafe/magical_cafe_01.jpg",
                    "assets/basel/Magical_Cafe/magical_cafe_02.jpg",
                    "assets/basel/Magical_Cafe/magical_cafe_03.jpg",
                    "assets/basel/Magical_Cafe/magical_cafe_04.jpg",
                    "assets/basel/Magical_Cafe/magical_cafe_05.jpg",
                    "assets/basel/Magical_Cafe/magical_cafe_06.jpg"
                ],
                fallbackCoords: [47.5699729, 7.5995347],
                filters: {
                    venueType: ["cafe"],
                    cuisineType: ["patisserie"],
                    ageRange: ["baby", "toddler", "small-child"],
                    amenities: ["play-area", "outdoor-seating", "high-chair", "change-table"]
                }
            },
            {
                name: "Klara 13",
                address: "Clarastrasse 13, 4058 Basel",
                city: "Basel",
                description: "Community food hall and cafe at Claraplatz with diverse kitchens from 5 continents and family-friendly space",
                i18n: {
                    description: {
                        de: "Gemeinschaftliche Foodhall und Café am Claraplatz mit Küchen aus 5 Kontinenten und familienfreundlichem Bereich",
                        fr: "Halle gourmande communautaire et café à Claraplatz avec cuisines variées des 5 continents et espace familial"
                    },
                    hours: {
                        de: "Mo-So: 10-22 Uhr (Küchenzeiten können variieren)",
                        fr: "Lun-dim : 10h-22h (horaires des cuisines variables)"
                    },
                    specialty: {
                        de: "Verschiedene Küchen unter einem Dach, zentrale Lage",
                        fr: "Plusieurs cuisines sous un même toit, emplacement central"
                    }
                },
                hours: "Daily: 10am-10pm (kitchen hours may vary)",
                specialty: "Multiple kitchens under one roof, central Claraplatz location",
                phone: "Contact via website",
                website: "https://www.klarabasel.ch/",
                images: [
                    "assets/basel/Klara/klara_01.jpg",
                    "assets/basel/Klara/klara_02.jpg",
                    "assets/basel/Klara/klara_03.jpg",
                    "assets/basel/Klara/klara_04.jpg",
                    "assets/basel/Klara/klara_05.jpg",
                    "assets/basel/Klara/klara_06.jpg",
                    "assets/basel/Klara/klara_07.jpg"
                ],
                fallbackCoords: [47.5660, 7.5950],
                filters: {
                    venueType: ["food-hall"],
                    cuisineType: ["international"],
                    ageRange: ["baby", "toddler", "small-child", "kid"],
                    amenities: ["play-area", "high-chair", "change-table", "games-room"]
                }
            },
            {
                name: "Markthalle Basel",
                address: "Steinentorberg 20, 4051 Basel",
                city: "Basel",
                description: "Historic market hall with international food stalls, cafes, open seating, and a family-friendly play area",
                i18n: {
                    description: {
                        de: "Historische Markthalle mit internationalen Food-Ständen, Cafés, offenen Sitzplätzen und einem familienfreundlichen Spielbereich",
                        fr: "Halle historique avec stands de cuisine internationale, cafés, places assises ouvertes et une aire de jeux familiale"
                    },
                    hours: {
                        de: "Mo-Sa: 8-23 Uhr (Stände variieren)",
                        fr: "Lun-sam : 8h-23h (horaires des stands variables)"
                    },
                    specialty: {
                        de: "Vielfältige Küche unter einer Kuppel, zentrale Lage am Bahnhof SBB",
                        fr: "Cuisine variée sous un dôme, emplacement central près de la gare CFF"
                    }
                },
                hours: "Mon-Sat: 8am-11pm (stalls vary)",
                specialty: "Varied kitchens under one dome, central near Basel SBB",
                phone: "Contact via website",
                website: "https://www.altemarkthalle.ch/",
                images: [
                    "assets/basel/Markthalle/markthalle_01.jpg",
                    "assets/basel/Markthalle/markthalle_02.jpg",
                    "assets/basel/Markthalle/markthalle_03.jpg",
                    "assets/basel/Markthalle/markthalle_04.jpg",
                    "assets/basel/Markthalle/markthalle_05.jpg",
                    "assets/basel/Markthalle/markthalle_06.jpg"
                ],
                fallbackCoords: [47.5480, 7.5898],
                filters: {
                    venueType: ["food-hall"],
                    cuisineType: ["international"],
                    ageRange: ["baby", "toddler", "small-child", "kid"],
                    amenities: ["play-area", "high-chair", "change-table", "outdoor-seating"]
                }
            }
        ];

        // Filter definitions
        const filterDefinitions = {
            venueType: [
                { id: "cafe", label: "Cafe" },
                { id: "craft-atelier", label: "Creative Atelier" },
                { id: "food-hall", label: "Food Hall" }
            ],
            cuisineType: [
                { id: "vegan", label: "Vegan" },
                { id: "bistro", label: "Bistro" },
                { id: "patisserie", label: "Patisserie" },
                { id: "international", label: "International" }
            ],
            ageRange: [
                { id: "baby", label: "Baby (0-1)" },
                { id: "toddler", label: "Toddler (2-3)" },
                { id: "small-child", label: "Small Child (4-6)" },
                { id: "kid", label: "Kid (7-12)" }
            ],
            amenities: [
                { id: "playground", label: "Playground" },
                { id: "outdoor-seating", label: "Outdoor Seating" },
                { id: "play-area", label: "Play Area" },
                { id: "friendly-spaces", label: "Friendly Spaces Playbox" },
                { id: "high-chair", label: "High Chair" },
                { id: "change-table", label: "Change Table" },
                { id: "games-room", label: "Games Room" }
            ]
        };

        // Initialize map with zoom controls in bottom right
        const map = L.map('map', {
            zoomControl: false
        });

        // Disable scroll zoom until the map is focused/clicked to prevent trapping page scroll
        map.scrollWheelZoom.disable();
        map.on('focus', () => map.scrollWheelZoom.enable());
        map.on('blur', () => map.scrollWheelZoom.disable());
        map.on('click', () => map.scrollWheelZoom.enable());

        // Add zoom control to bottom right
        L.control.zoom({
            position: 'bottomright'
        }).addTo(map);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
            maxZoom: 19
        }).addTo(map);

        // Initialize marker cluster group
        let markerClusterGroup = L.markerClusterGroup({
            maxClusterRadius: 150,
            spiderfyOnMaxZoom: true,
            showCoverageOnHover: false,
            disableClusteringAtZoom: 13,
            spiderfyDistanceMultiplier: 1.5
        });

        // Custom marker icon (brand blue gradient)
        const pinSvg = `
            <svg width="32" height="48" viewBox="0 0 32 48" xmlns="http://www.w3.org/2000/svg">
                <defs>
                    <linearGradient id="pinGrad" x1="50%" y1="0%" x2="50%" y2="100%">
                        <stop offset="0%" stop-color="#2F6BE0"/>
                        <stop offset="100%" stop-color="#1E52BA"/>
                    </linearGradient>
                    <filter id="pinShadow" x="-20%" y="-10%" width="140%" height="130%">
                        <feDropShadow dx="0" dy="2" stdDeviation="2" flood-color="rgba(0,0,0,0.25)"/>
                    </filter>
                </defs>
                <g filter="url(#pinShadow)">
                    <path fill="url(#pinGrad)" d="M16 0c-7.18 0-13 5.82-13 13 0 9.75 8.9 18.9 12.1 21.83.5.46 1.3.46 1.8 0C20.1 31.9 29 22.75 29 13 29 5.82 23.18 0 16 0Z"/>
                    <circle cx="16" cy="13" r="5" fill="rgba(255,255,255,0.9)"/>
                </g>
            </svg>
        `;

        const markerIcon = L.icon({
            iconUrl: 'data:image/svg+xml;utf8,' + encodeURIComponent(pinSvg),
            iconSize: [32, 48],
            iconAnchor: [16, 46],
            popupAnchor: [0, -42]
        });

        // Add click event to zoom into clusters
        markerClusterGroup.on('clusterclick', function (a) {
            // Prevent default cluster click behavior
            a.originalEvent.stopPropagation();

            // Get the bounds and zoom manually
            const bounds = a.layer.getBounds();

            map.fitBounds(bounds, {
                padding: [50, 50],
                maxZoom: 14,
                animate: true
            });

            // Force refresh after animation
            setTimeout(function() {
                markerClusterGroup.refreshClusters();
                map.invalidateSize();
                setTimeout(function() {
                    map.panBy([1, 0]);
                    map.panBy([-1, 0]);
                }, 50);
            }, 400);
        });

        map.addLayer(markerClusterGroup);

        // State
        let markers = [];
        let activeFilters = {
            venueType: [],
            cuisineType: [],
            ageRange: [],
            amenities: []
        };
        let searchQuery = '';
        let isInitialLoad = true;
        let activeTab = 'map';
        const favoritesKey = 'friendlyspaces_favorites';
        let favorites = new Set();
        const sidebar = document.getElementById('sidebar');
        const sheetBackdrop = document.getElementById('sheet-backdrop');
        const mapPanel = document.getElementById('map');
        const listPanel = document.getElementById('list-view');
        const listCards = document.getElementById('list-cards');
        const listEmpty = document.getElementById('list-empty');
        const bottomTabs = document.querySelectorAll('#bottom-tabs .bottom-tab-button');
        const detailModal = document.getElementById('detail-modal');
        const detailModalContent = document.getElementById('detail-modal-content');
        const sidebarFavorites = document.getElementById('sidebar-favorites');
        const sidebarFavoritesLabel = document.getElementById('sidebar-favorites-label');
        const resetFiltersButton = document.getElementById('reset-filters');
        const applyFiltersButton = document.getElementById('apply-filters');
        const menuToggle = document.getElementById('menu-toggle');
        const menuBackdrop = document.getElementById('menu-backdrop');
        const menuDrawer = document.getElementById('menu-drawer');
        const menuClose = document.getElementById('menu-close');
        const menuSuggest = document.getElementById('menu-suggest');
        const menuShare = document.getElementById('menu-share');
        const menuAbout = document.getElementById('menu-about');
        const suggestView = document.getElementById('suggest-view');
        const aboutView = document.getElementById('about-view');
        const suggestClose = document.getElementById('suggest-close');
        const aboutClose = document.getElementById('about-close');
        const suggestForm = document.getElementById('suggest-form');
        const suggestRoleButtons = document.querySelectorAll('[data-suggest-role]');
        const ownerFields = document.getElementById('owner-fields');

        // City coordinates for zoom
        const cityCoordinates = {
            'bern': [46.9480, 7.4474, 13],
            'basel': [47.5596, 7.5886, 13]
        };

        const isMobile = () => window.matchMedia('(max-width: 768px)').matches;

        function loadFavorites() {
            try {
                const raw = localStorage.getItem(favoritesKey);
                const parsed = raw ? JSON.parse(raw) : [];
                favorites = new Set(Array.isArray(parsed) ? parsed : []);
            } catch (err) {
                favorites = new Set();
            }
        }

        function saveFavorites() {
            localStorage.setItem(favoritesKey, JSON.stringify(Array.from(favorites)));
        }

        function isFavorite(venueName) {
            return favorites.has(venueName);
        }

        function toggleFavorite(venueName) {
            if (favorites.has(venueName)) {
                favorites.delete(venueName);
            } else {
                favorites.add(venueName);
            }
            saveFavorites();
            updateFavoritesBadge();
            updateMap();
            updateListView();
        }

        function updateFavoritesBadge() {
            const bottomBadge = document.getElementById('bottom-favorites-count');
            if (bottomBadge) bottomBadge.textContent = favorites.size;
        }

        function renderCountWrappers() {}

        function applyTranslations() {
            document.title = translate('ui.title', document.title);
            const appTitle = document.getElementById('app-title');
            if (appTitle) appTitle.textContent = translate('ui.title', appTitle.textContent);
            const sidebarTitle = document.getElementById('sidebar-title');
            if (sidebarTitle) sidebarTitle.textContent = translate('ui.sidebarTitle', sidebarTitle.textContent);

            const searchInputEl = document.getElementById('search-input');
            if (searchInputEl) searchInputEl.placeholder = translate('ui.searchPlaceholder', searchInputEl.placeholder);

            const topSearchInputEl = document.getElementById('top-search-input');
            if (topSearchInputEl) topSearchInputEl.placeholder = translate('ui.searchPlaceholder', topSearchInputEl.placeholder);

            if (resetFiltersButton) {
                resetFiltersButton.textContent = translate('ui.clearFilters', 'Reset all filters');
            }
            if (applyFiltersButton) {
                applyFiltersButton.textContent = translate('ui.showAllSpaces', 'Show all spaces');
            }

            const mapTab = document.getElementById('bottom-tab-map');
            if (mapTab) mapTab.textContent = translate('ui.mapTab', mapTab.textContent);

            const listTab = document.getElementById('bottom-tab-list');
            if (listTab) listTab.textContent = translate('ui.listTab', listTab.textContent);

            const favoritesTab = document.getElementById('bottom-tab-favorites-label');
            if (favoritesTab) favoritesTab.textContent = translate('ui.favoritesTab', favoritesTab.textContent);
            if (sidebarFavoritesLabel) {
                sidebarFavoritesLabel.textContent = translate('ui.favoritesTab', sidebarFavoritesLabel.textContent);
            }

            const installBannerText = document.getElementById('install-banner-text');
            if (installBannerText) installBannerText.textContent = translate('ui.favoritesInstall', installBannerText.textContent);
            const installButton = document.getElementById('install-button');
            if (installButton) installButton.textContent = translate('ui.favoritesInstallCta', installButton.textContent);

            document.querySelectorAll('[data-category-heading]').forEach(heading => {
                const cat = heading.getAttribute('data-category-heading');
                heading.textContent = translate(`filters.categories.${cat}`, heading.textContent);
            });

            renderCountWrappers();
        }

        function openMenu() {
            if (!menuDrawer || !menuBackdrop) return;
            menuDrawer.classList.add('open');
            menuBackdrop.classList.add('visible');
        }

        function closeMenu() {
            if (!menuDrawer || !menuBackdrop) return;
            menuDrawer.classList.remove('open');
            menuBackdrop.classList.remove('visible');
        }

        function openPanel(panel) {
            if (!panel) return;
            panel.classList.add('open');
            panel.setAttribute('aria-hidden', 'false');
        }

        function closePanel(panel) {
            if (!panel) return;
            panel.classList.remove('open');
            panel.setAttribute('aria-hidden', 'true');
        }

        function setSuggestRole(role) {
            suggestRoleButtons.forEach(btn => {
                btn.classList.toggle('active', btn.dataset.suggestRole === role);
            });
            if (ownerFields) {
                const isOwner = role === 'owner';
                ownerFields.style.display = isOwner ? 'block' : 'none';
                const ownerName = document.getElementById('owner-name');
                const ownerEmail = document.getElementById('owner-email');
                if (ownerName) ownerName.required = isOwner;
                if (ownerEmail) ownerEmail.required = isOwner;
            }
        }

        function updateLanguageToggleActive() {
            const buttons = document.querySelectorAll('#language-toggle button');
            buttons.forEach(btn => {
                const lang = btn.getAttribute('data-lang');
                btn.classList.toggle('active', lang === currentLang);
            });
        }

        function setLanguage(lang, { skipUrlUpdate = false } = {}) {
            if (!supportedLanguages.includes(lang)) return;
            currentLang = lang;
            document.documentElement.lang = lang;
            try {
                localStorage.setItem(languageKey, lang);
            } catch (err) {
                // Ignore storage errors.
            }

            if (!skipUrlUpdate) {
                const url = new URL(window.location.href);
                url.searchParams.set('lang', lang);
                history.replaceState({}, '', url.toString());
            }

            applyTranslations();
            updateLanguageToggleActive();
            createFilterButtons();
            updateFilterCount();
            updateMap();
            updateListView();
        }

        function openFilterSheet() {
            if (!isMobile()) return;
            sidebar.classList.add('show');
            sheetBackdrop.classList.add('visible');
            document.body.style.overflow = 'hidden';
        }

        function closeFilterSheet(force = false) {
            if (!isMobile() && !force) return;
            sidebar.classList.remove('show');
            sheetBackdrop.classList.remove('visible');
            document.body.style.overflow = isMobile() ? 'auto' : 'hidden';
        }

        function handleResize() {
            if (!isMobile()) {
                closeFilterSheet(true);
                document.body.style.overflow = 'hidden';
            } else {
                document.body.style.overflow = 'auto';
            }
            if (mapPanel && !mapPanel.classList.contains('hidden')) {
                setTimeout(() => map.invalidateSize(), 100);
            }
        }

        // Helper: Count venues with specific filter
        function countVenuesWithFilter(category, filterId) {
            return venues.filter(v => v.filters[category].includes(filterId)).length;
        }

        // Create filter buttons
        function createFilterButtons() {
            Object.keys(filterDefinitions).forEach(category => {
                const container = document.getElementById(`${category}-filters`);
                if (!container) return;
                container.innerHTML = '';

                const heading = document.querySelector(`[data-category-heading="${category}"]`);
                if (heading) {
                    heading.textContent = translate(`filters.categories.${category}`, heading.textContent);
                }

                const filters = [...filterDefinitions[category]];
                if (category === 'amenities') {
                    filters.sort((a, b) => {
                        if (a.id === 'friendly-spaces') return 1;
                        if (b.id === 'friendly-spaces') return -1;
                        return 0;
                    });
                }

                filters.forEach(filter => {
                    const count = countVenuesWithFilter(category, filter.id);

                    const button = document.createElement('button');
                    button.className = `filter-button${filter.id === 'friendly-spaces' ? ' wide' : ''}`;
                    if (activeFilters[category].includes(filter.id)) {
                        button.classList.add('active');
                    }
                    button.dataset.category = category;
                    button.dataset.value = filter.id;

                    const labelSpan = document.createElement('span');
                    const labelText = translate(`filters.options.${category}.${filter.id}`, filter.label || filter.id);
                    labelSpan.textContent = typeof labelText === 'function' ? labelText() : labelText;

                    const countSpan = document.createElement('span');
                    countSpan.className = 'count';
                    countSpan.textContent = count;

                    button.appendChild(labelSpan);
                    button.appendChild(countSpan);

                    button.addEventListener('click', () => handleFilterClick(button, category, filter.id));

                    container.appendChild(button);
                });
            });
        }

        // Handle filter button clicks
        function handleFilterClick(button, category, value) {
            button.classList.toggle('active');

            if (button.classList.contains('active')) {
                activeFilters[category].push(value);
            } else {
                activeFilters[category] = activeFilters[category].filter(v => v !== value);
            }

            updateMap();
            updateFilterCount();
        }

        // Search functionality with dropdown
        const searchInput = document.getElementById('search-input');
        const searchDropdown = document.getElementById('search-dropdown');
        const topSearchInput = document.getElementById('top-search-input');
        const topSearchDropdown = document.getElementById('top-search-dropdown');

        function updateSearchDropdown(query, dropdownEl) {
            const targetDropdown = dropdownEl || searchDropdown;
            const isTopSearch = targetDropdown === topSearchDropdown;
            const itemClass = isTopSearch ? 'top-search-dropdown-item' : 'search-dropdown-item';

            if (!query || query.length < 2) {
                targetDropdown.classList.remove('show');
                return;
            }

            const suggestions = [];

            // Add matching cities
            Object.keys(cityCoordinates).forEach(city => {
                if (city.toLowerCase().includes(query)) {
                    const venueCount = venues.filter(v => v.city.toLowerCase() === city.toLowerCase()).length;
                    const countLabel = translate('ui.cityCount', `${venueCount} venues`);
                    suggestions.push({
                        type: 'city',
                        name: city.charAt(0).toUpperCase() + city.slice(1),
                        count: typeof countLabel === 'function' ? countLabel(venueCount) : countLabel
                    });
                }
            });

            // Add matching venues
            venues.forEach(venue => {
                if (venue.name.toLowerCase().includes(query) ||
                    venue.address.toLowerCase().includes(query)) {
                    suggestions.push({
                        type: 'venue',
                        name: venue.name,
                        city: venue.city,
                        venue: venue
                    });
                }
            });

            if (suggestions.length === 0) {
                targetDropdown.classList.remove('show');
                return;
            }

            // Limit to 5 suggestions
            const limitedSuggestions = suggestions.slice(0, 5);

            targetDropdown.innerHTML = limitedSuggestions.map(s => {
                if (s.type === 'city') {
                    return `<div class="${itemClass}" data-type="city" data-city="${s.name.toLowerCase()}">
                        <strong>📍 ${s.name}</strong> - ${s.count}
                    </div>`;
                } else {
                    return `<div class="${itemClass}" data-type="venue" data-venue="${s.name}">
                        ${s.name} <span class="city-label">- ${s.city}</span>
                    </div>`;
                }
            }).join('');

            targetDropdown.classList.add('show');

            // Add click handlers
            targetDropdown.querySelectorAll(`.${itemClass}`).forEach(item => {
                item.addEventListener('click', () => {
                    const type = item.dataset.type;
                    if (type === 'city') {
                        const city = item.dataset.city;
                        handleCitySearch(city, isTopSearch);
                    } else {
                        const venueName = item.dataset.venue;
                        handleVenueSearch(venueName, isTopSearch);
                    }
                });
            });
        }

        function handleCitySearch(city, fromTopSearch = false) {
            const displayCity = city.charAt(0).toUpperCase() + city.slice(1);
            searchInput.value = displayCity;
            topSearchInput.value = displayCity;
            searchQuery = city.toLowerCase();
            searchDropdown.classList.remove('show');
            topSearchDropdown.classList.remove('show');

            // Zoom to city
            const coords = cityCoordinates[city.toLowerCase()];
            if (coords) {
                map.setView([coords[0], coords[1]], coords[2]);
            }

            updateMap();
        }

        function handleVenueSearch(venueName, fromTopSearch = false) {
            const venue = venues.find(v => v.name === venueName);
            if (venue) {
                searchInput.value = venue.name;
                topSearchInput.value = venue.name;
                searchQuery = venue.name.toLowerCase();
                searchDropdown.classList.remove('show');
                topSearchDropdown.classList.remove('show');

                // Zoom to venue
                map.setView(venue.fallbackCoords, 15);

                updateMap();

                // Open venue popup after a short delay
                setTimeout(() => {
                    const marker = markers.find(m => m.venue.name === venueName);
                    if (marker) {
                        marker.marker.openPopup();
                    }
                }, 300);
            }
        }

        // Sync both search inputs
        function syncSearchInputs(sourceInput, sourceDropdown) {
            searchQuery = sourceInput.value.toLowerCase();

            // Sync the other input
            if (sourceInput === searchInput) {
                topSearchInput.value = sourceInput.value;
                updateSearchDropdown(searchQuery, searchDropdown);
            } else {
                searchInput.value = sourceInput.value;
                updateSearchDropdown(searchQuery, topSearchDropdown);
            }

            updateMap();
        }

        searchInput.addEventListener('input', (e) => {
            syncSearchInputs(searchInput, searchDropdown);
        });

        topSearchInput.addEventListener('input', (e) => {
            syncSearchInputs(topSearchInput, topSearchDropdown);
        });

        searchInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && searchQuery) {
                const cityMatch = Object.keys(cityCoordinates).find(city =>
                    city === searchQuery ||
                    searchQuery.includes(city)
                );

                if (cityMatch) {
                    handleCitySearch(cityMatch);
                } else {
                    searchDropdown.classList.remove('show');
                }
            }
        });

        topSearchInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && searchQuery) {
                const cityMatch = Object.keys(cityCoordinates).find(city =>
                    city === searchQuery ||
                    searchQuery.includes(city)
                );

                if (cityMatch) {
                    handleCitySearch(cityMatch, true);
                } else {
                    topSearchDropdown.classList.remove('show');
                }
            }
        });

        // Close dropdowns when clicking outside
        document.addEventListener('click', (e) => {
            if (!searchInput.contains(e.target) && !searchDropdown.contains(e.target)) {
                searchDropdown.classList.remove('show');
            }
            if (!topSearchInput.contains(e.target) && !topSearchDropdown.contains(e.target)) {
                topSearchDropdown.classList.remove('show');
            }
        });

        function resetAllFilters() {
            activeFilters = {
                venueType: [],
                cuisineType: [],
                ageRange: [],
                amenities: []
            };
            searchQuery = '';
            if (searchInput) searchInput.value = '';
            if (topSearchInput) topSearchInput.value = '';
            setActiveView('map');
            createFilterButtons();
            updateFilterCount();
            isInitialLoad = true;
            updateMap();
            updateListView();
        }

        // Clear filters (legacy button removed; keep safe guard)
        const legacyClearBtn = document.getElementById('clear-filters');
        if (legacyClearBtn) {
            legacyClearBtn.addEventListener('click', resetAllFilters);
        }

        // Update filter count display
        function updateFilterCount() {
            const total = Object.values(activeFilters).flat().length;
            if (applyFiltersButton) {
                const label = total > 0
                    ? `${translate('ui.showSpaces', 'Show')} ${getVisibleVenues().length} ${translate('ui.spacesLabel', 'spaces')}`
                    : translate('ui.showAllSpaces', 'Show all spaces');
                applyFiltersButton.textContent = label;
            }
        }

        // Check if venue matches filters
        function venueMatchesFilters(venue) {
            if (activeTab === 'favorites' && !isFavorite(venue.name)) {
                return false;
            }

            // Search filter
            if (searchQuery) {
                const searchMatch =
                    venue.name.toLowerCase().includes(searchQuery) ||
                    venue.address.toLowerCase().includes(searchQuery) ||
                    venue.city.toLowerCase().includes(searchQuery);

                if (!searchMatch) return false;
            }

            // Category filters (AND logic - venue must have ALL selected filters)
            for (const [category, selectedFilters] of Object.entries(activeFilters)) {
                if (selectedFilters.length > 0) {
                    // Check if venue has ALL selected filters in this category
                    const hasAllFilters = selectedFilters.every(filter =>
                        venue.filters[category].includes(filter)
                    );
                    if (!hasAllFilters) return false;
                }
            }

            return true;
        }

        function getVisibleVenues() {
            return venues.filter(venueMatchesFilters);
        }

        // Color scheme for filter categories
        const categoryColors = {
            venueType: '#3b82f6',      // Blue
            cuisineType: '#10b981',    // Green
            ageRange: '#f59e0b',       // Orange
            amenities: '#8b5cf6'       // Purple
        };

        // Create popup content with color-coded tags and image slider
        function createPopup(venue) {
            const visitWebsiteLabel = translate('popup.visitWebsite', 'Visit Website');
            const hoursLabel = translate('popup.hours', 'Hours');
            const specialtyLabel = translate('popup.specialty', 'Specialty');
            const favoriteAddLabel = translate('ui.favoriteAdd', 'Save');
            const favoriteRemoveLabel = translate('ui.favoriteRemove', 'Saved');
            const seasonalNote = venue.seasonalNote
                ? (venue.seasonalNote[currentLang] || venue.seasonalNote.en || venue.seasonalNote.de)
                : null;

            const localizedDescription = getVenueText(venue, 'description');
            const localizedHours = getVenueText(venue, 'hours');
            const localizedSpecialty = getVenueText(venue, 'specialty');

            const tagsByCategory = Object.entries(venue.filters)
                .map(([category, values]) => {
                    const color = categoryColors[category];
                    const tags = values.map(v => {
                        const def = filterDefinitions[category].find(f => f.id === v);
                        const translated = translate(`filters.options.${category}.${v}`, def?.label || v);
                        const label = typeof translated === 'function' ? translated() : translated;
                        return `<span class="venue-tag" style="background: ${color}; color: white;">${label}</span>`;
                    }).join('');
                    return tags;
                })
                .join('');

            // Create Google Maps directions link
            const mapsUrl = `https://www.google.com/maps/dir/?api=1&destination=${encodeURIComponent(venue.address)}`;
            const phoneHref = formatPhoneHref(venue.phone);

            // Website link (if available)
            const websiteHtml = venue.website
                ? `<p style="margin: 5px 0; font-size: 13px;"><strong>🌐</strong> <a href="${venue.website}" target="_blank" rel="noopener noreferrer" style="color: #1E52BA; text-decoration: none;">${visitWebsiteLabel}</a></p>`
                : '';

            // Image slider (if images available)
            let sliderHtml = '';
            if (venue.images && venue.images.length > 0) {
                const sliderId = `slider-${venue.name.replace(/\s+/g, '-').toLowerCase()}`;
                const imagesHtml = venue.images.map((img, i) =>
                    `<img src="${img}" alt="${venue.name}" loading="${i === 0 ? 'eager' : 'lazy'}" decoding="async" ${i === 0 ? 'fetchpriority="high"' : 'fetchpriority="low"'} width="320" height="150">`
                ).join('');
                const dotsHtml = venue.images.map((_, i) =>
                    `<span class="slider-dot ${i === 0 ? 'active' : ''}" data-slide="${i}"></span>`
                ).join('');

                sliderHtml = `
                    <div class="venue-slider" id="${sliderId}">
                        <div class="slider-container">${imagesHtml}</div>
                    </div>
                `;
            }

            return `
                <div style="min-width: 240px; max-width: 300px;">
                    ${sliderHtml}
                    <div style="display: flex; align-items: center; justify-content: space-between; gap: 8px; margin: 0 0 10px 0;">
                        <h3 style="margin: 0; font-size: 16px; cursor: pointer;" onclick="openVenueProfile('${venue.name.replace(/'/g, "\\'")}')">${venue.name}</h3>
                        <button class="favorite-toggle ${isFavorite(venue.name) ? 'active' : ''}" data-venue="${venue.name}">
                            <svg class="favorite-icon ${isFavorite(venue.name) ? 'filled' : ''}" viewBox="0 0 24 24" aria-hidden="true">
                                <path d="M20.8 6.6c-1.4-1.4-3.8-1.4-5.2 0L12 10.2 8.4 6.6C7 5.2 4.6 5.2 3.2 6.6c-1.4 1.4-1.4 3.8 0 5.2L12 21l8.8-9.2c1.4-1.4 1.4-3.8 0-5.2z"></path>
                            </svg>
                            <span class="favorite-label">${isFavorite(venue.name) ? favoriteRemoveLabel : favoriteAddLabel}</span>
                        </button>
                    </div>
                    <p style="margin: 5px 0; font-size: 13px;"><strong>📍</strong> <a href="${mapsUrl}" target="_blank" rel="noopener noreferrer" style="color: #1E52BA; text-decoration: none;">${venue.address}</a></p>
                    <p style="margin: 5px 0; font-size: 13px;"><strong>📞</strong> ${phoneHref ? `<a href="${phoneHref}" style="color: #1E52BA; text-decoration: none;">${venue.phone}</a>` : venue.phone}</p>
                    ${websiteHtml}
                    <p style="margin: 8px 0; font-size: 13px;">${localizedDescription}</p>
                    <p style="margin: 5px 0; font-size: 12px; color: #666;"><strong>${hoursLabel}:</strong> ${localizedHours}</p>
                    ${seasonalNote ? `<p style="margin: 5px 0; font-size: 12px; color: #BA1E1E;"><strong>${seasonalNote}</strong></p>` : ''}
                    <p style="margin: 5px 0; font-size: 12px; color: #1E52BA;"><strong>${specialtyLabel}:</strong> ${localizedSpecialty}</p>
                    <div class="venue-tags">${tagsByCategory}</div>
                    <button onclick="openVenueProfile('${venue.name.replace(/'/g, "\\'")}')" style="width: 100%; margin-top: 12px; padding: 10px 16px; background: #1E52BA; color: white; border: none; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer;">${translate('popup.viewProfile', 'View Full Profile')}</button>
                </div>
            `;
        }

        // Update map markers
        function updateMap() {
            // Clear existing markers from cluster group
            markerClusterGroup.clearLayers();
            markers = [];

            const bounds = L.latLngBounds([]);
            let visibleCount = 0;
            const visibleVenues = getVisibleVenues();

            // Add markers for matching venues
            visibleVenues.forEach(venue => {
                if (!Array.isArray(venue.fallbackCoords) || venue.fallbackCoords.length < 2) {
                    return;
                }
                const coords = venue.fallbackCoords;
                const marker = L.marker(coords, { icon: markerIcon });
                marker.bindPopup(createPopup(venue), {
                    className: 'custom-popup',
                    maxWidth: 340,
                    minWidth: 240,
                    autoPanPaddingTopLeft: [40, 40],
                    autoPanPaddingBottomRight: [40, 40]
                });
                marker.on('popupopen', (e) => {
                    const target = e.popup.getLatLng();
                    map.panTo(target, { animate: true });
                    // Nudge popup fully into view; try a stronger upward pan
                    setTimeout(() => map.panBy([0, -140], { animate: true }), 150);

                    const sliderEl = e.popup.getElement()?.querySelector('.slider-container');
                    attachSliderScrollSync(sliderEl);
                    attachFavoriteHandlers(e.popup.getElement());
                });

                // Add marker to cluster group instead of directly to map
                markerClusterGroup.addLayer(marker);

                markers.push({ venue, marker, coords });
                bounds.extend(coords);
                visibleCount++;
            });

            // Update count
            // Only auto-zoom on initial load
            if (isInitialLoad) {
                if (bounds.isValid()) {
                    map.fitBounds(bounds.pad(0.2));
                } else {
                    map.setView([46.9480, 7.4474], 13);
                }
                isInitialLoad = false;
            }
            updateListView();
        }

        function renderVenueCard(venue) {
            const description = getVenueText(venue, 'description');
            const image = venue.images && venue.images.length > 0 ? venue.images[0] : '';
            const isFav = isFavorite(venue.name);
            const tags = venue.filters?.venueType || [];
            const tagHtml = tags.map(tag => {
                const def = filterDefinitions.venueType.find(item => item.id === tag);
                const translated = translate(`filters.options.venueType.${tag}`, def?.label || tag);
                const label = typeof translated === 'function' ? translated() : translated;
                return `<span class="venue-card-tag">${label}</span>`;
            }).join('');

            return `
                <article class="venue-card" data-venue="${venue.name}">
                    ${image
                        ? `<img class="venue-card-image" src="${image}" alt="${venue.name}" loading="lazy" decoding="async">`
                        : `<div class="venue-card-image" aria-hidden="true"></div>`}
                    <div class="venue-card-header">
                        <h3 class="venue-card-title">${venue.name}</h3>
                        <button class="venue-card-favorite ${isFav ? 'active' : ''}" data-venue="${venue.name}" type="button" aria-label="Save venue">
                            <svg class="favorite-icon ${isFav ? 'filled' : ''}" viewBox="0 0 24 24" aria-hidden="true">
                                <path d="M20.8 6.6c-1.4-1.4-3.8-1.4-5.2 0L12 10.2 8.4 6.6C7 5.2 4.6 5.2 3.2 6.6c-1.4 1.4-1.4 3.8 0 5.2L12 21l8.8-9.2c1.4-1.4 1.4-3.8 0-5.2z"></path>
                            </svg>
                        </button>
                    </div>
                    <div class="venue-card-meta">${venue.city}</div>
                    <div class="venue-card-address">${venue.address}</div>
                    <div class="venue-card-description">${description}</div>
                    <div class="venue-card-tags">${tagHtml}</div>
                </article>
            `;
        }

        function updateListView() {
            if (!listCards || !listEmpty) return;
            const visibleVenues = getVisibleVenues();
            listCards.innerHTML = visibleVenues.map(renderVenueCard).join('');

            const emptyTitle = activeTab === 'favorites'
                ? translate('ui.noFavoritesTitle', 'No favorites yet')
                : translate('ui.noVenuesTitle', 'No venues found');
            const emptyBody = activeTab === 'favorites'
                ? translate('ui.noFavoritesBody', 'Tap the heart to save places.')
                : translate('ui.noVenuesBody', 'Try clearing filters or searching another city.');

            listEmpty.hidden = visibleVenues.length > 0;
            listCards.hidden = visibleVenues.length === 0;
            listEmpty.innerHTML = `<strong style="display:block; margin-bottom:6px;">${emptyTitle}</strong>${emptyBody}`;
        }

        function createDetailProfileContent(venue) {
            const visitWebsiteLabel = translate('popup.visitWebsite', 'Visit Website');
            const hoursLabel = translate('popup.hours', 'Hours');
            const specialtyLabel = translate('popup.specialty', 'Specialty');
            const directionsLabel = translate('popup.directions', 'Directions');

            const seasonalNote = venue.seasonalNote
                ? (venue.seasonalNote[currentLang] || venue.seasonalNote.en || venue.seasonalNote.de)
                : null;

            const localizedDescription = getVenueText(venue, 'description');
            const localizedHours = getVenueText(venue, 'hours');
            const localizedSpecialty = getVenueText(venue, 'specialty');

            const mapsUrl = `https://www.google.com/maps/dir/?api=1&destination=${encodeURIComponent(venue.address)}`;
            const phoneHref = formatPhoneHref(venue.phone);
            const isFav = isFavorite(venue.name);

            // Build image slider
            let sliderHtml = '';
            if (venue.images && venue.images.length > 0) {
                const sliderId = `detail-slider-${venue.name.replace(/\s+/g, '-').toLowerCase()}`;
                const imagesHtml = venue.images.map((img, i) =>
                    `<img src="${img}" alt="${venue.name}" loading="${i === 0 ? 'eager' : 'lazy'}" decoding="async">`
                ).join('');
                const dotsHtml = venue.images.map((_, i) =>
                    `<span class="slider-dot ${i === 0 ? 'active' : ''}" data-slide="${i}"></span>`
                ).join('');

                sliderHtml = `
                    <div class="venue-slider" id="${sliderId}">
                        <div class="slider-container">${imagesHtml}</div>
                        ${venue.images.length > 1 ? `
                            <button class="slider-arrow prev" onclick="slideImage('${sliderId}', -1)">‹</button>
                            <button class="slider-arrow next" onclick="slideImage('${sliderId}', 1)">›</button>
                            <div class="slider-dots">${dotsHtml}</div>
                        ` : ''}
                    </div>
                `;
            }

            // Build tags by category
            const tagsHtml = Object.entries(venue.filters)
                .filter(([_, values]) => values.length > 0)
                .map(([category, values]) => {
                    return values.map(v => {
                        const def = filterDefinitions[category].find(f => f.id === v);
                        const translated = translate(`filters.options.${category}.${v}`, def?.label || v);
                        const label = typeof translated === 'function' ? translated() : translated;
                        return `<span class="detail-tag ${category}">${label}</span>`;
                    }).join('');
                })
                .join('');

            // Build phone contact
            const phoneHtml = venue.phone && phoneHref
                ? `<a class="detail-contact-item clickable" href="${phoneHref}">
                        <span class="detail-contact-icon">📞</span>
                        <span class="detail-contact-text">${venue.phone}</span>
                        <span class="detail-contact-arrow">→</span>
                   </a>`
                : venue.phone
                    ? `<div class="detail-contact-item">
                            <span class="detail-contact-icon">📞</span>
                            <span class="detail-contact-text">${venue.phone}</span>
                       </div>`
                    : '';

            // Build website contact
            const websiteHtml = venue.website
                ? `<a class="detail-contact-item clickable" href="${venue.website}" target="_blank" rel="noopener noreferrer">
                        <span class="detail-contact-icon">🌐</span>
                        <span class="detail-contact-text">${visitWebsiteLabel}</span>
                        <span class="detail-contact-arrow">→</span>
                   </a>`
                : '';

            return `
                <div class="detail-hero">
                    ${sliderHtml}
                    <div class="detail-hero-overlay">
                        <div class="detail-hero-info">
                            <h2 class="detail-hero-name">${venue.name}</h2>
                            <p class="detail-hero-address">${venue.city}</p>
                        </div>
                        <button class="detail-favorite-btn ${isFav ? 'active' : ''}" data-venue="${venue.name}" type="button" aria-label="Add to favorites">
                            <svg class="favorite-icon ${isFav ? 'filled' : ''}" viewBox="0 0 24 24" aria-hidden="true">
                                <path d="M20.8 6.6c-1.4-1.4-3.8-1.4-5.2 0L12 10.2 8.4 6.6C7 5.2 4.6 5.2 3.2 6.6c-1.4 1.4-1.4 3.8 0 5.2L12 21l8.8-9.2c1.4-1.4 1.4-3.8 0-5.2z"></path>
                            </svg>
                        </button>
                    </div>
                </div>
                <div class="detail-content">
                    <div class="detail-section">
                        <div class="detail-contact-list">
                            <a class="detail-contact-item clickable" href="${mapsUrl}" target="_blank" rel="noopener noreferrer">
                                <span class="detail-contact-icon">📍</span>
                                <span class="detail-contact-text">${venue.address}</span>
                                <span class="detail-contact-arrow">→</span>
                            </a>
                            ${phoneHtml}
                            ${websiteHtml}
                        </div>
                    </div>

                    <div class="detail-section">
                        <p class="detail-description">${localizedDescription}</p>
                    </div>

                    <div class="detail-section">
                        <div class="detail-info-row">
                            <span class="detail-info-label">${hoursLabel}</span>
                            <span class="detail-info-value">${localizedHours}</span>
                        </div>
                        ${seasonalNote ? `
                            <div class="detail-info-row">
                                <span class="detail-info-label">Note</span>
                                <span class="detail-info-value seasonal">${seasonalNote}</span>
                            </div>
                        ` : ''}
                        <div class="detail-info-row">
                            <span class="detail-info-label">${specialtyLabel}</span>
                            <span class="detail-info-value">${localizedSpecialty}</span>
                        </div>
                    </div>

                    <div class="detail-section">
                        <h3 class="detail-section-title">${translate('popup.features', 'Features')}</h3>
                        <div class="detail-tags">${tagsHtml}</div>
                    </div>
                </div>
            `;
        }

        function openDetailModal(venue) {
            if (!detailModal || !detailModalContent) return;

            // Generate content
            detailModalContent.innerHTML = createDetailProfileContent(venue);

            // Trigger slide-in animation
            detailModal.classList.add('entering');
            detailModal.setAttribute('aria-hidden', 'false');

            // Force reflow then add active class for animation
            detailModal.offsetHeight;
            detailModal.classList.add('active');
            detailModal.classList.remove('entering');

            // Prevent body scroll
            document.body.style.overflow = 'hidden';

            // Attach event handlers
            const favoriteBtn = detailModalContent.querySelector('.detail-favorite-btn');
            if (favoriteBtn) {
                favoriteBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    const venueName = favoriteBtn.dataset.venue;
                    toggleFavorite(venueName);
                    const isFav = isFavorite(venueName);
                    favoriteBtn.classList.toggle('active', isFav);
                    const heartIcon = favoriteBtn.querySelector('.favorite-icon');
                    if (heartIcon) heartIcon.classList.toggle('filled', isFav);
                });
            }

            const sliderEl = detailModalContent.querySelector('.slider-container');
            attachSliderScrollSync(sliderEl);
        }

        function closeDetailModal() {
            if (!detailModal) return;

            // Animate out - different animation for mobile vs desktop
            if (isMobile()) {
                detailModal.style.transform = 'translateX(100%)';
            } else {
                detailModal.style.opacity = '0';
                const card = detailModal.querySelector('.detail-modal-card');
                if (card) card.style.transform = 'scale(0.95)';
            }

            setTimeout(() => {
                detailModal.classList.remove('active');
                detailModal.setAttribute('aria-hidden', 'true');
                detailModal.style.transform = '';
                detailModal.style.opacity = '';
                const card = detailModal.querySelector('.detail-modal-card');
                if (card) card.style.transform = '';

                // Restore body scroll
                if (isMobile()) {
                    document.body.style.overflow = 'auto';
                } else {
                    document.body.style.overflow = 'hidden';
                }
            }, 300);
        }

        function setActiveView(view) {
            activeTab = view;
            bottomTabs.forEach(btn => {
                btn.classList.toggle('active', btn.dataset.view === view);
            });
            if (sidebarFavorites) {
                sidebarFavorites.classList.toggle('active', view === 'favorites');
            }
            const showMap = view === 'map';
            if (mapPanel) mapPanel.classList.toggle('hidden', !showMap);
            if (listPanel) listPanel.classList.toggle('hidden', showMap);
            if (showMap) {
                setTimeout(() => map.invalidateSize(), 100);
            }
            closeDetailModal();
            updateMap();
            updateListView();
        }

        if (sheetBackdrop) {
            sheetBackdrop.addEventListener('click', () => closeFilterSheet());
        }

        // Swipe down to close filters sheet on mobile
        let sheetTouchStartY = 0;
        let sheetTouchStartX = 0;
        let isSheetSwiping = false;

        if (sidebar) {
            sidebar.addEventListener('touchstart', (e) => {
                if (!isMobile()) return;
                const touch = e.touches[0];
                const sidebarTop = sidebar.getBoundingClientRect().top;
                const startInHandleZone = touch.clientY <= sidebarTop + 48;
                const atTop = sidebar.scrollTop <= 0;
                if (!startInHandleZone || !atTop) {
                    sheetTouchStartY = 0;
                    sheetTouchStartX = 0;
                    isSheetSwiping = false;
                    return;
                }
                sheetTouchStartY = touch.clientY;
                sheetTouchStartX = touch.clientX;
                isSheetSwiping = false;
            }, { passive: true });

            sidebar.addEventListener('touchmove', (e) => {
                if (!isMobile() || !sheetTouchStartY) return;
                const touch = e.touches[0];
                const diffY = touch.clientY - sheetTouchStartY;
                const diffX = Math.abs(touch.clientX - sheetTouchStartX);

                if (diffY > 20 && diffY > diffX * 1.4) {
                    isSheetSwiping = true;
                    sidebar.style.transform = `translateY(${diffY}px)`;
                }
            }, { passive: true });

            sidebar.addEventListener('touchend', () => {
                if (!isMobile()) return;
                if (isSheetSwiping) {
                    const currentTransform = parseFloat(sidebar.style.transform.replace(/[^0-9.-]/g, '')) || 0;
                    if (currentTransform > 120) {
                        sidebar.style.transform = '';
                        closeFilterSheet(true);
                    } else {
                        sidebar.style.transform = '';
                    }
                }
                sheetTouchStartY = 0;
                sheetTouchStartX = 0;
                isSheetSwiping = false;
            }, { passive: true });
        }

        window.addEventListener('resize', handleResize);

        // Image slider functionality
        const sliderIndices = {};

        function slideImage(sliderId, direction) {
            const slider = document.getElementById(sliderId);
            if (!slider) return;

            const sliderContainer = slider.querySelector('.slider-container');
            const images = sliderContainer.querySelectorAll('img');
            const dots = slider.querySelectorAll('.slider-dot');

            if (!sliderIndices[sliderId]) {
                sliderIndices[sliderId] = 0;
            }

            // Calculate new index
            sliderIndices[sliderId] = (sliderIndices[sliderId] + direction + images.length) % images.length;

            // Update slider position via scroll
            const slideWidth = sliderContainer.clientWidth || slider.clientWidth;
            const targetScroll = sliderIndices[sliderId] * slideWidth;
            sliderContainer.scrollTo({ left: targetScroll, behavior: 'smooth' });

            // Update dots
            dots.forEach((dot, index) => {
                if (index === sliderIndices[sliderId]) {
                    dot.classList.add('active');
                } else {
                    dot.classList.remove('active');
                }
            });
        }

        // Make slideImage globally accessible for onclick handlers
        window.slideImage = slideImage;

        function attachSliderScrollSync(sliderEl) {
            if (!sliderEl || sliderEl.dataset.bound === 'true') return;
            const sliderId = sliderEl.closest('.venue-slider')?.id;
            if (!sliderId) return;
            sliderEl.dataset.bound = 'true';
            const dots = sliderEl.parentElement.querySelectorAll('.slider-dot');
            sliderEl.addEventListener('scroll', () => {
                const slideWidth = sliderEl.clientWidth || 1;
                const idx = Math.round(sliderEl.scrollLeft / slideWidth);
                sliderIndices[sliderId] = idx;
                dots.forEach((dot, i) => dot.classList.toggle('active', i === idx));
            });
        }

        function attachFavoriteHandlers(popupEl) {
            if (!popupEl) return;
            const btn = popupEl.querySelector('.favorite-toggle');
            if (!btn || btn.dataset.bound === 'true') return;
            btn.dataset.bound = 'true';
            btn.addEventListener('click', (e) => {
                e.preventDefault();
                const venueName = btn.dataset.venue;
                toggleFavorite(venueName);
                const isFav = isFavorite(venueName);
                btn.classList.toggle('active', isFav);
                const heart = btn.querySelector('.favorite-icon');
                const label = btn.querySelector('.favorite-label');
                if (heart) heart.classList.toggle('filled', isFav);
                if (label) label.textContent = isFav
                    ? translate('ui.favoriteRemove', 'Saved')
                    : translate('ui.favoriteAdd', 'Save');
            });
        }

        bottomTabs.forEach(btn => {
            btn.addEventListener('click', () => {
                setActiveView(btn.dataset.view || 'map');
            });
        });

        if (sidebarFavorites) {
            sidebarFavorites.addEventListener('click', () => {
                if (activeTab === 'favorites') {
                    setActiveView('map');
                } else {
                    setActiveView('favorites');
                }
                if (sidebar.classList.contains('show')) {
                    closeFilterSheet();
                }
            });
        }

        if (resetFiltersButton) {
            resetFiltersButton.addEventListener('click', resetAllFilters);
        }

        if (applyFiltersButton) {
            applyFiltersButton.addEventListener('click', () => closeFilterSheet());
        }

        const languageButtons = document.querySelectorAll('#language-toggle button');
        languageButtons.forEach(btn => {
            btn.addEventListener('click', () => {
                const lang = btn.getAttribute('data-lang');
                setLanguage(lang);
            });
        });

        if (menuToggle) {
            menuToggle.addEventListener('click', openMenu);
        }
        if (menuClose) {
            menuClose.addEventListener('click', closeMenu);
        }
        if (menuBackdrop) {
            menuBackdrop.addEventListener('click', closeMenu);
        }
        if (menuSuggest) {
            menuSuggest.addEventListener('click', () => {
                closeMenu();
                openPanel(suggestView);
            });
        }
        if (menuAbout) {
            menuAbout.addEventListener('click', () => {
                closeMenu();
                openPanel(aboutView);
            });
        }
        if (menuShare) {
            menuShare.addEventListener('click', async () => {
                const shareUrl = `${window.location.origin}${window.location.pathname}`;
                const shareData = {
                    title: 'Friendly Spaces',
                    text: 'Find family-friendly venues in Switzerland.',
                    url: shareUrl
                };
                try {
                    if (navigator.share) {
                        await navigator.share(shareData);
                    } else if (navigator.clipboard) {
                        await navigator.clipboard.writeText(shareUrl);
                        alert('Link copied to clipboard.');
                    } else {
                        prompt('Copy this link:', shareUrl);
                    }
                } catch (err) {
                    // Ignore cancelled share.
                }
            });
        }
        if (suggestClose) {
            suggestClose.addEventListener('click', () => closePanel(suggestView));
        }
        if (aboutClose) {
            aboutClose.addEventListener('click', () => closePanel(aboutView));
        }
        suggestRoleButtons.forEach(btn => {
            btn.addEventListener('click', () => setSuggestRole(btn.dataset.suggestRole));
        });
        if (suggestForm) {
            suggestForm.addEventListener('submit', (event) => {
                event.preventDefault();
                const role = Array.from(suggestRoleButtons).find(btn => btn.classList.contains('active'))?.dataset.suggestRole || 'owner';
                const venueName = document.getElementById('venue-name')?.value || '';
                const venueCity = document.getElementById('venue-city')?.value || '';
                const venueWhy = document.getElementById('venue-why')?.value || '';
                const ownerName = document.getElementById('owner-name')?.value || '';
                const ownerEmail = document.getElementById('owner-email')?.value || '';
                const ownerPhone = document.getElementById('owner-phone')?.value || '';

                const lines = [
                    `Role: ${role === 'owner' ? 'Venue owner' : 'Friendly Spaces enthusiast'}`,
                    `Venue name: ${venueName}`,
                    `City: ${venueCity}`
                ];
                if (venueWhy) lines.push(`Why friendly: ${venueWhy}`);
                if (role === 'owner') {
                    if (ownerName) lines.push(`Owner name: ${ownerName}`);
                    if (ownerEmail) lines.push(`Owner email: ${ownerEmail}`);
                    if (ownerPhone) lines.push(`Owner phone: ${ownerPhone}`);
                }

                const subject = encodeURIComponent('Friendly Spaces venue suggestion');
                const body = encodeURIComponent(lines.join('\n'));
                const to = 'hello@friendlyspaces.com';
                window.location.href = `mailto:${to}?subject=${subject}&body=${body}`;
            });
        }

        if (listCards) {
            listCards.addEventListener('click', (event) => {
                const favoriteButton = event.target.closest('.venue-card-favorite');
                if (favoriteButton) {
                    event.preventDefault();
                    event.stopPropagation();
                    const venueName = favoriteButton.dataset.venue;
                    toggleFavorite(venueName);
                    return;
                }

                const card = event.target.closest('.venue-card');
                if (!card) return;
                const venueName = card.dataset.venue;
                const venue = venues.find(v => v.name === venueName);
                if (venue) openDetailModal(venue);
            });
        }

        const modalClose = document.getElementById('detail-modal-close');
        if (modalClose) {
            modalClose.addEventListener('click', closeDetailModal);
        }

        if (detailModal) {
            detailModal.addEventListener('click', (event) => {
                // Close when clicking backdrop (on desktop) or the modal background on mobile
                if (event.target === detailModal || event.target.classList.contains('detail-modal-card')) {
                    // Only close if clicking the card background on mobile, not the modal itself
                    if (event.target === detailModal && !isMobile()) {
                        closeDetailModal();
                    }
                }
            });
        }

        document.addEventListener('keydown', (event) => {
            if (event.key === 'Escape') {
                closeDetailModal();
            }
        });

        // Global function to open venue profile from popup
        window.openVenueProfile = function(venueName) {
            const venue = venues.find(v => v.name === venueName);
            if (venue) {
                map.closePopup();
                openDetailModal(venue);
            }
        };

        // Install prompt banner
        let deferredPrompt = null;
        const installBanner = document.getElementById('install-banner');
        const installButton = document.getElementById('install-button');

        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            if (installBanner) installBanner.classList.remove('hidden');
        });

        if (installButton) {
            installButton.addEventListener('click', async () => {
                if (!deferredPrompt) return;
                deferredPrompt.prompt();
                await deferredPrompt.userChoice;
                deferredPrompt = null;
                if (installBanner) installBanner.classList.add('hidden');
            });
        }

        window.addEventListener('appinstalled', () => {
            if (installBanner) installBanner.classList.add('hidden');
        });

        // Quick filter pills functionality
        const pillFilters = document.getElementById('pill-filters');
        const pillFavorites = document.getElementById('pill-favorites');
        const quickFilterPills = document.querySelectorAll('.quick-filter-pill[data-filter-category]');

        // Update quick filter pill labels based on current language
        function updateQuickFilterLabels() {
            document.querySelectorAll('[data-pill-label]').forEach(label => {
                const key = label.dataset.pillLabel;
                if (key === 'filters') {
                    label.textContent = translate('ui.filtersLabel', 'Filters');
                } else if (key === 'cafe') {
                    label.textContent = translate('filters.options.venueType.cafe', 'Cafe');
                } else if (key === 'baby') {
                    label.textContent = translate('filters.options.ageRange.baby', 'Baby');
                } else if (key === 'toddler') {
                    label.textContent = translate('filters.options.ageRange.toddler', 'Toddler');
                } else if (key === 'play-area') {
                    label.textContent = translate('filters.options.amenities.play-area', 'Play Area');
                }
            });
        }

        // Sync quick filter pills with sidebar filter state
        function syncQuickFilterPills() {
            quickFilterPills.forEach(pill => {
                const category = pill.dataset.filterCategory;
                const value = pill.dataset.filterValue;
                const isActive = activeFilters[category].includes(value);
                pill.classList.toggle('active', isActive);
            });

            // Update favorites pill active state
            if (pillFavorites) {
                pillFavorites.classList.toggle('active', activeTab === 'favorites');
            }
        }

        // Toggle a quick filter
        function toggleQuickFilter(category, value) {
            const index = activeFilters[category].indexOf(value);
            if (index === -1) {
                activeFilters[category].push(value);
            } else {
                activeFilters[category].splice(index, 1);
            }

            // Also update the sidebar filter button state
            const sidebarBtn = document.querySelector(`.filter-button[data-category="${category}"][data-value="${value}"]`);
            if (sidebarBtn) {
                sidebarBtn.classList.toggle('active', activeFilters[category].includes(value));
            }

            updateMap();
            updateFilterCount();
            syncQuickFilterPills();
        }

        // Filters pill - opens sidebar/sheet
        if (pillFilters) {
            pillFilters.addEventListener('click', () => {
                if (isMobile()) {
                    if (sidebar.classList.contains('show')) {
                        closeFilterSheet();
                    } else {
                        openFilterSheet();
                    }
                } else {
                    // On desktop, toggle sidebar visibility or just scroll to filters
                    sidebar.scrollIntoView({ behavior: 'smooth' });
                }
            });
        }

        // Favorites pill - toggles favorites view
        if (pillFavorites) {
            pillFavorites.addEventListener('click', () => {
                if (activeTab === 'favorites') {
                    // Switch back to map view
                    setActiveView('map');
                } else {
                    // Switch to favorites view
                    setActiveView('favorites');
                }
                syncQuickFilterPills();
            });
        }

        // Quick filter pills - toggle their respective filters
        quickFilterPills.forEach(pill => {
            pill.addEventListener('click', () => {
                const category = pill.dataset.filterCategory;
                const value = pill.dataset.filterValue;
                toggleQuickFilter(category, value);
            });
        });

        // Extend setLanguage to also update quick filter labels
        const originalSetLanguage = setLanguage;
        setLanguage = function(lang, options) {
            originalSetLanguage(lang, options);
            updateQuickFilterLabels();
            syncQuickFilterPills();
        };

        // Extend setActiveView to sync pills
        const originalSetActiveView = setActiveView;
        setActiveView = function(view) {
            originalSetActiveView(view);
            syncQuickFilterPills();
        };

        // Initialize
        loadFavorites();
        updateFavoritesBadge();
        setLanguage(currentLang, { skipUrlUpdate: true });
        handleResize();
        updateQuickFilterLabels();
        syncQuickFilterPills();
        setSuggestRole('owner');

        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js').catch(() => {});
            });
        }
    </script>
</body>
</html>
