<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Friendly Spaces</title>
    <meta name="theme-color" content="#1E52BA">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icons/icon-192.png">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
    <style>
        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            overflow: hidden;
            min-height: 100dvh;
            display: flex;
            flex-direction: column;
            background: #f7f5f1;
        }

        #container {
            display: flex;
            flex: 1;
            min-height: 0;
        }

        #app-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 16px;
            padding: 16px 20px;
            background: #1E52BA;
        }

        #brand {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        #brand-logo-wrap {
            display: flex;
            align-items: center;
            justify-content: center;
            background: transparent;
            padding: 0;
        }

        #brand-logo {
            display: block;
            height: 24px;
            width: auto;
        }

        #app-title {
            display: none;
        }

        #language-toggle {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px;
            border-radius: 999px;
            background: rgba(255, 255, 255, 0.2);
        }

        #language-toggle button {
            border: none;
            background: transparent;
            padding: 6px 10px;
            border-radius: 999px;
            font-size: 11px;
            font-weight: 700;
            color: rgba(255, 255, 255, 0.8);
            cursor: pointer;
        }

        #language-toggle button.active {
            background: white;
            color: #1E52BA;
        }

        /* Mobile summary bar */
        #mobile-summary-bar {
            display: none;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
            padding: 12px 16px;
            background: white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            position: sticky;
            top: 0;
            z-index: 1002;
        }

        #mobile-summary-bar .count {
            font-size: 14px;
            color: #333;
        }

        #mobile-filter-toggle {
            background: #1E52BA;
            color: white;
            border: none;
            border-radius: 20px;
            padding: 8px 14px;
            font-size: 14px;
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
        }

        #sheet-backdrop {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.25);
            z-index: 1000;
        }

        #sheet-backdrop.visible {
            display: block;
        }

        #sidebar {
            width: 350px;
            background: #ffffff;
            box-shadow: 2px 0 8px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            z-index: 1001;
            transition: transform 0.3s ease;
            padding-bottom: 72px;
        }

        #sidebar.collapsed {
            transform: translateX(-350px);
        }

        #sidebar-header {
            padding: 20px;
            background: #1E52BA;
            color: white;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        #sidebar-header h2 {
            margin: 0 0 10px 0;
            font-size: 20px;
        }

        .language-toggle {
            display: none;
        }

        #search-container {
            position: relative;
        }

        #search-input {
            width: 100%;
            padding: 12px 40px 12px 15px;
            border: none;
            border-radius: 25px;
            font-size: 14px;
            outline: none;
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
        }

        #search-icon {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #1E52BA;
        }

        #search-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border-radius: 15px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            margin-top: 8px;
            max-height: 200px;
            overflow-y: auto;
            display: none;
            z-index: 1000;
        }

        #search-dropdown.show {
            display: block;
        }

        .search-dropdown-item {
            padding: 12px 15px;
            cursor: pointer;
            border-bottom: 1px solid #f0f0f0;
            font-size: 13px;
        }

        .search-dropdown-item:last-child {
            border-bottom: none;
        }

        .search-dropdown-item:hover {
            background: #f8f9fa;
        }

        .search-dropdown-item strong {
            color: #1E52BA;
        }

        #favorites-tabs {
            display: flex;
            gap: 8px;
        }

        .tab-button {
            flex: 1;
            border: none;
            border-radius: 18px;
            padding: 8px 10px;
            font-size: 13px;
            cursor: pointer;
            background: rgba(255,255,255,0.2);
            color: white;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            transition: background 0.2s ease;
        }

        .tab-button.active {
            background: white;
            color: #1E52BA;
            font-weight: 600;
        }

        .tab-badge {
            background: #BA1E1E;
            color: white;
            border-radius: 12px;
            padding: 2px 6px;
            font-size: 11px;
            min-width: 18px;
            text-align: center;
        }

        #filters-container {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        .filter-category {
            margin-bottom: 25px;
            border-radius: 12px;
            border: 1px solid #eee;
            padding: 12px;
            background: #fafbff;
        }

        .filter-category h3 {
            margin: 0 0 12px 0;
            font-size: 14px;
            color: #333;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
        }

        .filter-category h3::after {
            content: '▾';
            font-size: 12px;
            color: #1E52BA;
        }

        .filter-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .filter-category.collapsed .filter-buttons {
            display: none;
        }

        .filter-category.collapsed h3::after {
            content: '▸';
        }

        .filter-button {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 8px 14px;
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 20px;
            cursor: pointer;
            font-size: 13px;
            color: #495057;
            transition: all 0.2s;
            user-select: none;
        }

        .filter-button:hover {
            background: #e9ecef;
            border-color: #dee2e6;
        }

        .filter-button.active {
            background: #1E52BA;
            border-color: #1E52BA;
            color: white;
        }

        .filter-button .count {
            font-size: 11px;
            background: rgba(0, 0, 0, 0.1);
            padding: 2px 6px;
            border-radius: 10px;
        }

        .filter-button.active .count {
            background: #F8F5EF;
            color: #1E52BA;
        }

        #active-filters {
            padding: 15px 20px;
            border-top: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        #filter-count {
            font-size: 14px;
            color: #1E52BA;
            font-weight: 600;
        }

        #clear-filters {
            background: none;
            border: 1px solid #1E52BA;
            color: #1E52BA;
            padding: 6px 15px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s;
        }

        #clear-filters:hover {
            background: #1E52BA;
            color: white;
        }

        #clear-filters:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        #map {
            flex: 1;
            height: 100%;
            width: 100%;
        }

        #main-view {
            position: relative;
            flex: 1;
            min-height: 0;
            background: #f7f5f1;
        }

        .view-panel {
            position: absolute;
            inset: 0;
        }

        .view-panel.hidden {
            display: none;
        }

        #list-view {
            overflow-y: auto;
            padding: 16px 16px 120px;
        }

        .venue-list {
            display: flex;
            flex-direction: column;
            gap: 14px;
        }

        .venue-card {
            background: #ffffff;
            border-radius: 16px;
            border: 1px solid #ebe7e0;
            padding: 14px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.04);
            display: flex;
            flex-direction: column;
            gap: 10px;
            cursor: pointer;
        }

        .venue-card-image {
            width: 100%;
            height: 150px;
            border-radius: 12px;
            object-fit: cover;
            background: #f0ebe4;
        }

        .venue-card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
        }

        .venue-card-title {
            margin: 0;
            font-size: 16px;
            font-weight: 700;
            color: #1c1b19;
        }

        .venue-card-meta {
            font-size: 12px;
            color: #6f6b65;
            font-weight: 600;
        }

        .venue-card-address {
            font-size: 12px;
            color: #7b7873;
        }

        .venue-card-description {
            font-size: 13px;
            color: #3b3834;
        }

        .venue-card-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }

        .venue-card-tag {
            padding: 4px 8px;
            border-radius: 999px;
            background: #f0ebe4;
            font-size: 11px;
            color: #4c4a45;
        }

        .venue-card-favorite {
            border: 1px solid #d8d4cd;
            background: #ffffff;
            border-radius: 999px;
            padding: 6px 10px;
            font-size: 12px;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .venue-card-favorite.active {
            background: #1E52BA;
            border-color: #1E52BA;
            color: #ffffff;
        }

        .list-empty {
            padding: 40px 20px;
            text-align: center;
            color: #66625d;
        }

        #bottom-tabs {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 64px;
            background: #ffffff;
            border-top: 1px solid #e3ded6;
            display: flex;
            align-items: center;
            justify-content: space-around;
            z-index: 1002;
        }

        .bottom-tab-button {
            border: none;
            background: transparent;
            display: inline-flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            font-size: 12px;
            font-weight: 600;
            color: #4c4a45;
            cursor: pointer;
        }

        .bottom-tab-button.active {
            color: #1E52BA;
        }

        .bottom-tab-badge {
            background: #BA1E1E;
            color: #ffffff;
            border-radius: 999px;
            padding: 2px 6px;
            font-size: 10px;
            min-width: 18px;
            text-align: center;
        }

        #detail-modal {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.35);
            display: none;
            align-items: flex-end;
            justify-content: center;
            z-index: 1005;
        }

        #detail-modal.active {
            display: flex;
        }

        .detail-modal-card {
            width: min(520px, 100%);
            background: #ffffff;
            border-radius: 20px 20px 0 0;
            padding: 16px;
            max-height: 80dvh;
            overflow-y: auto;
            position: relative;
        }

        #detail-modal-close {
            position: sticky;
            top: 0;
            margin-left: auto;
            border: none;
            background: #1E52BA;
            color: white;
            border-radius: 999px;
            padding: 6px 12px;
            font-size: 12px;
            cursor: pointer;
            display: block;
        }

        #toggle-sidebar {
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 1001;
            background: white;
            border: 2px solid rgba(0,0,0,0.2);
            border-radius: 4px;
            padding: 8px 12px;
            cursor: pointer;
            font-size: 18px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
            display: none;
        }

        #result-count {
            padding: 10px 20px;
            background: #f8f9fa;
            border-bottom: 1px solid #eee;
            font-size: 13px;
            color: #666;
        }

        .leaflet-popup-content h3 {
            margin-top: 0;
            color: #1E52BA;
        }

        .venue-tags {
            margin-top: 10px;
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
        }

        .venue-tag {
            background: #e9ecef;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 11px;
            color: #495057;
        }

        /* Mobile responsive */
        @media (max-width: 768px) {
            body {
                overflow-y: auto;
            }

            #container {
                flex-direction: column;
                min-height: 100dvh;
            }

            #mobile-summary-bar {
                display: flex;
            }

            #sidebar {
                position: fixed;
                left: 0;
                right: 0;
                bottom: 0;
                width: 100%;
                max-height: 70dvh;
                transform: translateY(100%);
                box-shadow: 0 -4px 12px rgba(0,0,0,0.15);
                border-radius: 16px 16px 0 0;
                transition: transform 0.3s ease;
                padding-top: 12px;
                padding-bottom: 20px;
            }

            #sidebar.show {
                transform: translateY(0);
            }

            #filters-container {
                max-height: 50dvh;
                padding-top: 10px;
            }

            #active-filters {
                position: sticky;
                bottom: 0;
                background: white;
            }

            #map {
                height: 100%;
                min-height: 50dvh;
            }

            #toggle-sidebar {
                display: none !important;
            }

            #app-header {
                padding: 12px 16px;
            }

            #app-title {
                font-size: 18px;
            }

            #brand {
                gap: 10px;
            }

            #brand-logo-wrap {
                padding: 5px 8px;
                border-radius: 10px;
            }

            #brand-logo {
                height: 20px;
            }
        }

        /* Custom scrollbar */
        #filters-container::-webkit-scrollbar {
            width: 6px;
        }

        #filters-container::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        #filters-container::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 3px;
        }

        #filters-container::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        /* Marker cluster styling */
        .marker-cluster-small,
        .marker-cluster-medium,
        .marker-cluster-large {
            background: #1E52BA;
        }

        .marker-cluster-small div,
        .marker-cluster-medium div,
        .marker-cluster-large div {
            background: #1E52BA;
            color: white;
            font-weight: bold;
        }

        .marker-cluster {
            background-clip: padding-box;
        }

        /* Image slider styles */
        .venue-slider {
            position: relative;
            width: 100%;
            margin-bottom: 10px;
            overflow: hidden;
            border-radius: 8px;
        }

        .venue-slider img {
            width: 100%;
            height: 150px;
            object-fit: cover;
            display: block;
            flex-shrink: 0;
            flex: 0 0 100%;
            scroll-snap-align: center;
            scroll-snap-stop: always;
            background: #f5f5f5;
        }

        .slider-container {
            display: flex;
            width: auto;
            min-width: 100%;
            overflow-x: auto;
            scroll-snap-type: x mandatory;
            scroll-behavior: smooth;
        }

        .slider-arrow {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(255, 255, 255, 0.9);
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            cursor: pointer;
            font-size: 16px;
            z-index: 10;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .slider-arrow:hover {
            background: white;
        }

        .slider-arrow.prev {
            left: 5px;
        }

        .slider-arrow.next {
            right: 5px;
        }

        .slider-dots {
            text-align: center;
            padding: 5px 0;
            position: absolute;
            bottom: 5px;
            width: 100%;
        }

        .slider-dot {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.5);
            margin: 0 3px;
        }

        .slider-dot.active {
            background: white;
        }

        /* Popup sizing */
        .custom-popup .leaflet-popup-content-wrapper {
            max-width: 340px;
            width: clamp(260px, 70vw, 340px);
        }

        .custom-popup .leaflet-popup-content {
            margin: 8px 10px;
            max-height: 320px;
            overflow-y: auto;
            overflow-x: hidden;
        }

        .favorite-toggle {
            border: none;
            background: #f2f4fb;
            color: #1E52BA;
            border-radius: 18px;
            padding: 6px 10px;
            font-size: 12px;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .favorite-toggle.active {
            background: #1E52BA;
            color: white;
        }

        .favorite-heart {
            font-size: 14px;
            line-height: 1;
        }

        .install-banner {
            position: sticky;
            top: 0;
            z-index: 1003;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            padding: 10px 16px;
            background: #1E52BA;
            color: white;
            font-size: 13px;
        }

        .install-banner.hidden {
            display: none;
        }

        .install-banner button {
            background: white;
            color: #1E52BA;
            border: none;
            border-radius: 16px;
            padding: 6px 12px;
            font-size: 12px;
            cursor: pointer;
        }

        /* Top Search Bar - Always visible */
        #top-search-bar {
            background: white;
            padding: 12px 20px;
            display: flex;
            align-items: center;
            gap: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        #top-search-container {
            flex: 1;
            max-width: 600px;
            position: relative;
        }

        #top-search-input {
            width: 100%;
            padding: 14px 48px 14px 20px;
            border: 1px solid #e0e0e0;
            border-radius: 28px;
            font-size: 15px;
            background: #f8f9fa;
            color: #333;
            outline: none;
            transition: background 0.2s, box-shadow 0.2s, border-color 0.2s;
        }

        #top-search-input:focus {
            background: #fff;
            border-color: #1E52BA;
            box-shadow: 0 2px 8px rgba(30,82,186,0.15);
        }

        #top-search-input::placeholder {
            color: #888;
        }

        #top-search-input:focus {
            background: #4a4a4a;
            box-shadow: 0 0 0 2px rgba(30, 82, 186, 0.5);
        }

        #top-search-icon {
            position: absolute;
            right: 16px;
            top: 50%;
            transform: translateY(-50%);
            color: #1E52BA;
            pointer-events: none;
        }

        #top-search-dropdown {
            position: absolute;
            top: calc(100% + 8px);
            left: 0;
            right: 0;
            background: white;
            border-radius: 16px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.2);
            max-height: 280px;
            overflow-y: auto;
            display: none;
            z-index: 1010;
        }

        #top-search-dropdown.show {
            display: block;
        }

        .top-search-dropdown-item {
            padding: 14px 18px;
            cursor: pointer;
            border-bottom: 1px solid #f0f0f0;
            font-size: 14px;
            color: #333;
        }

        .top-search-dropdown-item:last-child {
            border-bottom: none;
        }

        .top-search-dropdown-item:hover {
            background: #f8f9fa;
        }

        .top-search-dropdown-item strong {
            color: #1E52BA;
        }

        .top-search-dropdown-item .city-label {
            color: #888;
            font-size: 13px;
        }

        /* Hide sidebar search on mobile since top bar is primary */
        @media (max-width: 768px) {
            #search-container {
                display: none;
            }

            #top-search-bar {
                padding: 10px 16px;
            }

            #top-search-input {
                padding: 12px 44px 12px 16px;
                font-size: 14px;
            }
        }
    </style>
</head>
<body>
    <div id="install-banner" class="install-banner hidden">
        <span id="install-banner-text">Install Friendly Spaces for quick access.</span>
        <button id="install-button">Add to Home Screen</button>
    </div>
    <header id="app-header">
        <div id="brand">
            <span id="brand-logo-wrap">
                <img id="brand-logo" src="assets/FriendlySpaces_white.png" alt="Friendly Spaces">
            </span>
            <h1 id="app-title">Friendly Spaces</h1>
        </div>
        <div id="language-toggle" aria-label="Language switcher">
            <button type="button" data-lang="de">DE</button>
            <button type="button" data-lang="fr">FR</button>
            <button type="button" data-lang="en">EN</button>
        </div>
    </header>
    <div id="top-search-bar">
        <div id="top-search-container">
            <input type="text" id="top-search-input" placeholder="Search by name, city, or address...">
            <span id="top-search-icon" aria-hidden="true">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="11" cy="11" r="7"></circle>
                    <line x1="16.65" y1="16.65" x2="21" y2="21"></line>
                </svg>
            </span>
            <div id="top-search-dropdown"></div>
        </div>
    </div>
    <div id="sheet-backdrop"></div>
    <div id="mobile-summary-bar">
        <span class="count">Showing <strong id="venue-count-mobile">0</strong> venues</span>
        <button id="mobile-filter-toggle">Filters</button>
    </div>
    <div id="container">
        <aside id="sidebar">
            <div id="sidebar-header">
                <h2 id="sidebar-title">Find Venues</h2>
                <div id="search-container">
                    <input type="text" id="search-input" placeholder="Search by name, city, or address...">
                    <span id="search-icon" aria-hidden="true">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#1E52BA" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="11" cy="11" r="7"></circle>
                            <line x1="16.65" y1="16.65" x2="21" y2="21"></line>
                        </svg>
                    </span>
                    <div id="search-dropdown"></div>
                </div>
            </div>

            <div id="result-count">Showing <strong id="venue-count">0</strong> venues</div>

            <div id="filters-container">
                <div class="filter-category">
                    <h3 data-category-heading="venueType">Venue Type</h3>
                    <div class="filter-buttons" id="venueType-filters"></div>
                </div>

                <div class="filter-category">
                    <h3 data-category-heading="cuisineType">Cuisine Type</h3>
                    <div class="filter-buttons" id="cuisineType-filters"></div>
                </div>

                <div class="filter-category">
                    <h3 data-category-heading="ageRange">Age Range</h3>
                    <div class="filter-buttons" id="ageRange-filters"></div>
                </div>

                <div class="filter-category">
                    <h3 data-category-heading="amenities">Amenities</h3>
                    <div class="filter-buttons" id="amenities-filters"></div>
                </div>
            </div>

            <div id="active-filters">
                <span id="filter-count">0 filters active</span>
                <button id="clear-filters" disabled>Clear All</button>
            </div>
        </aside>

        <div id="main-view">
            <button id="toggle-sidebar">☰</button>
            <div id="map" class="view-panel"></div>
            <div id="list-view" class="view-panel hidden">
                <div id="list-cards" class="venue-list"></div>
                <div id="list-empty" class="list-empty" hidden>No venues found.</div>
            </div>
        </div>
    </div>
    <nav id="bottom-tabs" aria-label="Primary">
        <button class="bottom-tab-button active" data-view="map" id="bottom-tab-map" type="button">Map</button>
        <button class="bottom-tab-button" data-view="list" id="bottom-tab-list" type="button">List</button>
        <button class="bottom-tab-button" data-view="favorites" id="bottom-tab-favorites" type="button">
            <span id="bottom-tab-favorites-label">Favorites</span>
            <span class="bottom-tab-badge" id="bottom-favorites-count">0</span>
        </button>
    </nav>
    <div id="detail-modal" role="dialog" aria-modal="true" aria-hidden="true">
        <div class="detail-modal-card">
            <button id="detail-modal-close" type="button">Close</button>
            <div id="detail-modal-content"></div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
    <script>
        // Language support (German/French) with query param override (?lang=de|fr)
        const supportedLanguages = ['de', 'fr', 'en'];
        const translations = {
            de: {
                ui: {
                    title: "Familienfreundliche Karte - Bern",
                    sidebarTitle: "Orte finden",
                    searchPlaceholder: "Nach Name, Stadt oder Adresse suchen...",
                    languageLabel: "Sprache",
                    showingLabel: "Zeige",
                    venuesLabel: "Orte",
                    filtersLabel: "Filter",
                    clearFilters: "Alle löschen",
                    allTab: "Alle",
                    favoritesTab: "Favoriten",
                    mapTab: "Karte",
                    listTab: "Liste",
                    noVenuesTitle: "Keine Orte gefunden",
                    noVenuesBody: "Versuche andere Filter oder eine neue Suche.",
                    noFavoritesTitle: "Noch keine Favoriten",
                    noFavoritesBody: "Tippe auf das Herz, um Orte zu speichern.",
                    favoritesInstall: "Friendly Spaces installieren",
                    favoritesInstallCta: "Zum Homescreen",
                    favoriteAdd: "Merken",
                    favoriteRemove: "Gespeichert",
                    filtersActive: (count) => count === 1 ? "1 Filter aktiv" : `${count} Filter aktiv`,
                    filtersButton: (count) => count > 0 ? `Filter (${count})` : "Filter",
                    cityCount: (count) => count === 1 ? "1 Ort" : `${count} Orte`,
                },
                filters: {
                    categories: {
                        venueType: "Ortstyp",
                        cuisineType: "Küche",
                        ageRange: "Altersgruppe",
                        amenities: "Ausstattung"
                    },
                    options: {
                        venueType: {
                            cafe: "Café",
                            "craft-atelier": "Kreativ-Atelier",
                            "food-hall": "Food Hall"
                        },
                        cuisineType: {
                            vegan: "Vegan",
                            bistro: "Bistro",
                            patisserie: "Patisserie",
                            international: "International"
                        },
                        ageRange: {
                            baby: "Baby (0-1)",
                            toddler: "Kleinkind (2-3)",
                            "small-child": "Kind (4-6)",
                            kid: "Schulkind (7-12)"
                        },
                        amenities: {
                            playground: "Spielplatz",
                            "outdoor-seating": "Aussensitzplätze",
                            "play-area": "Spielbereich",
                            "friendly-spaces": "Friendly Spaces Playbox",
                            "high-chair": "Kinderstuhl",
                            "change-table": "Wickeltisch",
                            "games-room": "Spielzimmer"
                        }
                    }
                },
                popup: {
                    visitWebsite: "Webseite besuchen",
                    hours: "Öffnungszeiten",
                    specialty: "Besonderheit",
                    directions: "Route planen"
                }
            },
            fr: {
                ui: {
                    title: "Carte des lieux familiaux - Berne",
                    sidebarTitle: "Trouver des lieux",
                    searchPlaceholder: "Rechercher par nom, ville ou adresse...",
                    languageLabel: "Langue",
                    showingLabel: "Afficher",
                    venuesLabel: "lieux",
                    filtersLabel: "Filtres",
                    clearFilters: "Tout effacer",
                    allTab: "Tous",
                    favoritesTab: "Favoris",
                    mapTab: "Carte",
                    listTab: "Liste",
                    noVenuesTitle: "Aucun lieu trouvé",
                    noVenuesBody: "Essayez d'autres filtres ou une nouvelle recherche.",
                    noFavoritesTitle: "Pas encore de favoris",
                    noFavoritesBody: "Touchez le cœur pour enregistrer.",
                    favoritesInstall: "Installer Friendly Spaces",
                    favoritesInstallCta: "Ajouter à l'écran",
                    favoriteAdd: "Enregistrer",
                    favoriteRemove: "Enregistré",
                    filtersActive: (count) => count === 1 ? "1 filtre actif" : `${count} filtres actifs`,
                    filtersButton: (count) => count > 0 ? `Filtres (${count})` : "Filtres",
                    cityCount: (count) => count === 1 ? "1 lieu" : `${count} lieux`,
                },
                filters: {
                    categories: {
                        venueType: "Type de lieu",
                        cuisineType: "Type de cuisine",
                        ageRange: "Tranche d'âge",
                        amenities: "Équipements"
                    },
                    options: {
                        venueType: {
                            cafe: "Café",
                            "craft-atelier": "Atelier créatif",
                            "food-hall": "Food Hall"
                        },
                        cuisineType: {
                            vegan: "Végane",
                            bistro: "Bistrot",
                            patisserie: "Pâtisserie",
                            international: "Cuisine internationale"
                        },
                        ageRange: {
                            baby: "Bébé (0-1)",
                            toddler: "Tout-petit (2-3)",
                            "small-child": "Jeune enfant (4-6)",
                            kid: "Enfant (7-12)"
                        },
                        amenities: {
                            playground: "Terrain de jeu",
                            "outdoor-seating": "Terrasse extérieure",
                            "play-area": "Aire de jeux",
                            "friendly-spaces": "Friendly Spaces Playbox",
                            "high-chair": "Chaise haute",
                            "change-table": "Table à langer",
                            "games-room": "Salle de jeux"
                        }
                    }
                },
                popup: {
                    visitWebsite: "Visiter le site",
                    hours: "Horaires",
                    specialty: "Spécialité",
                    directions: "Itinéraire"
                }
            },
            en: {
                ui: {
                    title: "Friendly Spaces",
                    sidebarTitle: "Find Venues",
                    searchPlaceholder: "Search by name, city, or address...",
                    languageLabel: "Language",
                    showingLabel: "Showing",
                    venuesLabel: "venues",
                    filtersLabel: "Filters",
                    clearFilters: "Clear All",
                    allTab: "All",
                    favoritesTab: "Favorites",
                    mapTab: "Map",
                    listTab: "List",
                    noVenuesTitle: "No venues found",
                    noVenuesBody: "Try clearing filters or searching another city.",
                    noFavoritesTitle: "No favorites yet",
                    noFavoritesBody: "Tap the heart to save places.",
                    favoritesInstall: "Install Friendly Spaces",
                    favoritesInstallCta: "Add to Home Screen",
                    favoriteAdd: "Save",
                    favoriteRemove: "Saved",
                    filtersActive: (count) => count === 1 ? "1 filter active" : `${count} filters active`,
                    filtersButton: (count) => count > 0 ? `Filters (${count})` : "Filters",
                    cityCount: (count) => count === 1 ? "1 venue" : `${count} venues`,
                },
                filters: {
                    categories: {
                        venueType: "Venue Type",
                        cuisineType: "Cuisine Type",
                        ageRange: "Age Range",
                        amenities: "Amenities"
                    },
                    options: {
                        venueType: {
                            cafe: "Cafe",
                            "craft-atelier": "Creative Atelier",
                            "food-hall": "Food Hall"
                        },
                        cuisineType: {
                            vegan: "Vegan",
                            bistro: "Bistro",
                            patisserie: "Patisserie",
                            international: "International"
                        },
                        ageRange: {
                            baby: "Baby (0-1)",
                            toddler: "Toddler (2-3)",
                            "small-child": "Small Child (4-6)",
                            kid: "Kid (7-12)"
                        },
                        amenities: {
                            playground: "Playground",
                            "outdoor-seating": "Outdoor Seating",
                            "play-area": "Play Area",
                            "friendly-spaces": "Friendly Spaces Playbox",
                            "high-chair": "High Chair",
                            "change-table": "Change Table",
                            "games-room": "Games Room"
                        }
                    }
                },
                popup: {
                    visitWebsite: "Visit Website",
                    hours: "Hours",
                    specialty: "Specialty",
                    directions: "Directions"
                }
            }
        };

        const languageKey = 'friendlyspaces_lang';
        let currentLang = getPreferredLanguage();

        function getPreferredLanguage() {
            const params = new URLSearchParams(window.location.search);
            const fromQuery = params.get('lang')?.toLowerCase();
            if (fromQuery && supportedLanguages.includes(fromQuery)) return fromQuery;

            try {
                const stored = localStorage.getItem(languageKey);
                if (stored && supportedLanguages.includes(stored)) {
                    return stored;
                }
            } catch (err) {
                // Ignore storage issues and fall back to browser language.
            }

            const browser = (navigator.language || navigator.userLanguage || '').slice(0, 2).toLowerCase();
            if (supportedLanguages.includes(browser)) return browser;

            return 'de'; // default to German
        }

        document.documentElement.lang = currentLang;

        function translate(path, fallback) {
            const segments = path.split('.');
            const value =
                segments.reduce((obj, key) => obj?.[key], translations[currentLang]) ??
                segments.reduce((obj, key) => obj?.[key], translations['de']);
            return value !== undefined ? value : fallback;
        }

        function formatPhoneHref(phone) {
            if (!phone) return null;
            if (/contact via website/i.test(phone)) return null;
            const normalized = phone.replace(/[^+\d]/g, '');
            if (!normalized || normalized.replace(/\D/g, '').length === 0) return null;
            return `tel:${normalized}`;
        }

        // Helper to get localized venue text fields
        function getVenueText(venue, field) {
            const localized = venue.i18n?.[field];
            if (localized && typeof localized === 'object') {
                return localized[currentLang] ||
                    venue[field] ||
                    localized['en'] ||
                    localized['de'] ||
                    '';
            }
            return venue[field] || '';
        }

        // Venue data with filter tags
        const venues = [
            {
                name: "Orangerie Elfenau",
                address: "Elfenauweg 92, 3006 Bern",
                city: "Bern",
                description: "Elegant cafe and bistro in a historic orangery surrounded by beautiful gardens",
                i18n: {
                    description: {
                        de: "Elegantes Café und Bistro in einer historischen Orangerie mit Gartenambiente",
                        fr: "Café-bistro élégant dans une orangerie historique entourée de jardins"
                    },
                    hours: {
                        de: "Mi-So: 11-19 Uhr (Saisonzeiten können variieren)",
                        fr: "Mer-dim : 11h-19h (horaires saisonniers variables)"
                    },
                    specialty: {
                        de: "Gartenterrasse und hausgemachte Kuchen",
                        fr: "Terrasse jardin et gâteaux maison"
                    }
                },
                hours: "Wed-Sun: 11am-7pm (seasonal hours may vary)",
                specialty: "Garden terrace and homemade cakes",
                seasonalNote: {
                    de: "Derzeit geschlossen bis April (Saisonbetrieb)",
                    fr: "Actuellement fermé jusqu'en avril (ouverture saisonnière)",
                    en: "Currently closed until April (seasonal)"
                },
                phone: "+41 31 350 16 20",
                website: "https://orangerieelfenau.ch/",
                images: [
                    "assets/bern/Orangerie_Elfenau/Orangerie_01.jpg",
                    "assets/bern/Orangerie_Elfenau/Orangerie_02.jpg",
                    "assets/bern/Orangerie_Elfenau/Orangerie_03.jpg",
                    "assets/bern/Orangerie_Elfenau/Orangerie_04.jpg",
                    "assets/bern/Orangerie_Elfenau/Orangerie_06.jpg"
                ],
                fallbackCoords: [46.9330368, 7.4659898],
                filters: {
                    venueType: ["cafe"],
                    cuisineType: ["bistro"],
                    ageRange: ["baby", "toddler", "small-child", "kid"],
                    amenities: ["outdoor-seating", "playground", "friendly-spaces", "high-chair", "change-table"]
                }
            },
            {
                name: "Love is Sweet Atelier",
                address: "Socinstrasse 2, 4051 Basel",
                city: "Basel",
                description: "Creative craft atelier offering art workshops for children including jewelry, ceramics, painting, and more",
                i18n: {
                    description: {
                        de: "Kreatives Atelier mit Kunstworkshops für Kinder, darunter Schmuck, Keramik, Malen und mehr",
                        fr: "Atelier créatif proposant des ateliers d'art pour enfants : bijoux, céramique, peinture et plus"
                    },
                    hours: {
                        de: "Workshop-Zeiten variieren – siehe Website für den Plan",
                        fr: "Horaires des ateliers variables – consulter le site pour le planning"
                    },
                    specialty: {
                        de: "Kunstworkshops und kreative Aktivitäten für Kinder",
                        fr: "Ateliers d'art et activités créatives pour enfants"
                    }
                },
                hours: "Workshop hours vary - check website for schedule",
                specialty: "Art workshops and creative activities for kids",
                phone: "Contact via website",
                website: "https://loveissweet.ch/",
                images: [
                    "assets/basel/LIS_Atelier/LIS_Atelier_01.jpg",
                    "assets/basel/LIS_Atelier/LIS_Atelier_02.jpg",
                    "assets/basel/LIS_Atelier/LIS_Atelier_03.jpg",
                    "assets/basel/LIS_Atelier/LIS_Atelier_04.jpg",
                    "assets/basel/LIS_Atelier/LIS_Atelier_05.jpg"
                ],
                fallbackCoords: [47.5580748, 7.5792603],
                filters: {
                    venueType: ["craft-atelier"],
                    cuisineType: [],
                    ageRange: ["toddler", "small-child", "kid"],
                    amenities: ["high-chair", "change-table"]
                }
            },
            {
                name: "Magical Cafe",
                address: "Max Kämpf Platz 2, 4058 Basel",
                city: "Basel",
                description: "Family-friendly cafe with homemade cupcakes, coffee, and large indoor play area for children",
                i18n: {
                    description: {
                        de: "Familienfreundliches Café mit hausgemachten Cupcakes, Kaffee und grossem Indoor-Spielbereich",
                        fr: "Café familial avec cupcakes maison, café et grande aire de jeux intérieure"
                    },
                    hours: {
                        de: "Di-Fr: 10-17 Uhr (Wochenenden für Privatfeiern reserviert)",
                        fr: "Mar-ven : 10h-17h (week-ends réservés aux fêtes privées)"
                    },
                    specialty: {
                        de: "Hausgemachte Cupcakes und thematische Geburtstagsfeiern",
                        fr: "Cupcakes maison et fêtes d'anniversaire à thème"
                    }
                },
                hours: "Tue-Fri: 10am-5pm (weekends reserved for private parties)",
                specialty: "Homemade cupcakes and themed birthday parties",
                phone: "+41 78 905 37 38",
                website: "https://magicalcafe.ch/",
                images: [
                    "assets/basel/Magical_Cafe/magical_cafe_01.jpg",
                    "assets/basel/Magical_Cafe/magical_cafe_02.jpg",
                    "assets/basel/Magical_Cafe/magical_cafe_03.jpg",
                    "assets/basel/Magical_Cafe/magical_cafe_04.jpg",
                    "assets/basel/Magical_Cafe/magical_cafe_05.jpg",
                    "assets/basel/Magical_Cafe/magical_cafe_06.jpg"
                ],
                fallbackCoords: [47.5699729, 7.5995347],
                filters: {
                    venueType: ["cafe"],
                    cuisineType: ["patisserie"],
                    ageRange: ["baby", "toddler", "small-child"],
                    amenities: ["play-area", "outdoor-seating", "high-chair", "change-table"]
                }
            },
            {
                name: "Klara 13",
                address: "Clarastrasse 13, 4058 Basel",
                city: "Basel",
                description: "Community food hall and cafe at Claraplatz with diverse kitchens from 5 continents and family-friendly space",
                i18n: {
                    description: {
                        de: "Gemeinschaftliche Foodhall und Café am Claraplatz mit Küchen aus 5 Kontinenten und familienfreundlichem Bereich",
                        fr: "Halle gourmande communautaire et café à Claraplatz avec cuisines variées des 5 continents et espace familial"
                    },
                    hours: {
                        de: "Mo-So: 10-22 Uhr (Küchenzeiten können variieren)",
                        fr: "Lun-dim : 10h-22h (horaires des cuisines variables)"
                    },
                    specialty: {
                        de: "Verschiedene Küchen unter einem Dach, zentrale Lage",
                        fr: "Plusieurs cuisines sous un même toit, emplacement central"
                    }
                },
                hours: "Daily: 10am-10pm (kitchen hours may vary)",
                specialty: "Multiple kitchens under one roof, central Claraplatz location",
                phone: "Contact via website",
                website: "https://www.klarabasel.ch/",
                images: [
                    "assets/basel/Klara/klara_01.jpg",
                    "assets/basel/Klara/klara_02.jpg",
                    "assets/basel/Klara/klara_03.jpg",
                    "assets/basel/Klara/klara_04.jpg",
                    "assets/basel/Klara/klara_05.jpg",
                    "assets/basel/Klara/klara_06.jpg",
                    "assets/basel/Klara/klara_07.jpg"
                ],
                fallbackCoords: [47.5660, 7.5950],
                filters: {
                    venueType: ["food-hall"],
                    cuisineType: ["international"],
                    ageRange: ["baby", "toddler", "small-child", "kid"],
                    amenities: ["play-area", "high-chair", "change-table", "games-room"]
                }
            },
            {
                name: "Markthalle Basel",
                address: "Steinentorberg 20, 4051 Basel",
                city: "Basel",
                description: "Historic market hall with international food stalls, cafes, open seating, and a family-friendly play area",
                i18n: {
                    description: {
                        de: "Historische Markthalle mit internationalen Food-Ständen, Cafés, offenen Sitzplätzen und einem familienfreundlichen Spielbereich",
                        fr: "Halle historique avec stands de cuisine internationale, cafés, places assises ouvertes et une aire de jeux familiale"
                    },
                    hours: {
                        de: "Mo-Sa: 8-23 Uhr (Stände variieren)",
                        fr: "Lun-sam : 8h-23h (horaires des stands variables)"
                    },
                    specialty: {
                        de: "Vielfältige Küche unter einer Kuppel, zentrale Lage am Bahnhof SBB",
                        fr: "Cuisine variée sous un dôme, emplacement central près de la gare CFF"
                    }
                },
                hours: "Mon-Sat: 8am-11pm (stalls vary)",
                specialty: "Varied kitchens under one dome, central near Basel SBB",
                phone: "Contact via website",
                website: "https://www.altemarkthalle.ch/",
                images: [
                    "assets/basel/Markthalle/markthalle_01.jpg",
                    "assets/basel/Markthalle/markthalle_02.jpg",
                    "assets/basel/Markthalle/markthalle_03.jpg",
                    "assets/basel/Markthalle/markthalle_04.jpg",
                    "assets/basel/Markthalle/markthalle_05.jpg",
                    "assets/basel/Markthalle/markthalle_06.jpg"
                ],
                fallbackCoords: [47.5480, 7.5898],
                filters: {
                    venueType: ["food-hall"],
                    cuisineType: ["international"],
                    ageRange: ["baby", "toddler", "small-child", "kid"],
                    amenities: ["play-area", "high-chair", "change-table", "outdoor-seating"]
                }
            }
        ];

        // Filter definitions
        const filterDefinitions = {
            venueType: [
                { id: "cafe", label: "Cafe" },
                { id: "craft-atelier", label: "Creative Atelier" },
                { id: "food-hall", label: "Food Hall" }
            ],
            cuisineType: [
                { id: "vegan", label: "Vegan" },
                { id: "bistro", label: "Bistro" },
                { id: "patisserie", label: "Patisserie" },
                { id: "international", label: "International" }
            ],
            ageRange: [
                { id: "baby", label: "Baby (0-1)" },
                { id: "toddler", label: "Toddler (2-3)" },
                { id: "small-child", label: "Small Child (4-6)" },
                { id: "kid", label: "Kid (7-12)" }
            ],
            amenities: [
                { id: "playground", label: "Playground" },
                { id: "outdoor-seating", label: "Outdoor Seating" },
                { id: "play-area", label: "Play Area" },
                { id: "friendly-spaces", label: "Friendly Spaces Playbox" },
                { id: "high-chair", label: "High Chair" },
                { id: "change-table", label: "Change Table" },
                { id: "games-room", label: "Games Room" }
            ]
        };

        // Initialize map with zoom controls in bottom right
        const map = L.map('map', {
            zoomControl: false
        });

        // Disable scroll zoom until the map is focused/clicked to prevent trapping page scroll
        map.scrollWheelZoom.disable();
        map.on('focus', () => map.scrollWheelZoom.enable());
        map.on('blur', () => map.scrollWheelZoom.disable());
        map.on('click', () => map.scrollWheelZoom.enable());

        // Add zoom control to bottom right
        L.control.zoom({
            position: 'bottomright'
        }).addTo(map);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
            maxZoom: 19
        }).addTo(map);

        // Initialize marker cluster group
        let markerClusterGroup = L.markerClusterGroup({
            maxClusterRadius: 150,
            spiderfyOnMaxZoom: true,
            showCoverageOnHover: false,
            disableClusteringAtZoom: 13,
            spiderfyDistanceMultiplier: 1.5
        });

        // Custom marker icon (brand blue gradient)
        const pinSvg = `
            <svg width="32" height="48" viewBox="0 0 32 48" xmlns="http://www.w3.org/2000/svg">
                <defs>
                    <linearGradient id="pinGrad" x1="50%" y1="0%" x2="50%" y2="100%">
                        <stop offset="0%" stop-color="#2F6BE0"/>
                        <stop offset="100%" stop-color="#1E52BA"/>
                    </linearGradient>
                    <filter id="pinShadow" x="-20%" y="-10%" width="140%" height="130%">
                        <feDropShadow dx="0" dy="2" stdDeviation="2" flood-color="rgba(0,0,0,0.25)"/>
                    </filter>
                </defs>
                <g filter="url(#pinShadow)">
                    <path fill="url(#pinGrad)" d="M16 0c-7.18 0-13 5.82-13 13 0 9.75 8.9 18.9 12.1 21.83.5.46 1.3.46 1.8 0C20.1 31.9 29 22.75 29 13 29 5.82 23.18 0 16 0Z"/>
                    <circle cx="16" cy="13" r="5" fill="rgba(255,255,255,0.9)"/>
                </g>
            </svg>
        `;

        const markerIcon = L.icon({
            iconUrl: 'data:image/svg+xml;utf8,' + encodeURIComponent(pinSvg),
            iconSize: [32, 48],
            iconAnchor: [16, 46],
            popupAnchor: [0, -42]
        });

        // Add click event to zoom into clusters
        markerClusterGroup.on('clusterclick', function (a) {
            // Prevent default cluster click behavior
            a.originalEvent.stopPropagation();

            // Get the bounds and zoom manually
            const bounds = a.layer.getBounds();

            map.fitBounds(bounds, {
                padding: [50, 50],
                maxZoom: 14,
                animate: true
            });

            // Force refresh after animation
            setTimeout(function() {
                markerClusterGroup.refreshClusters();
                map.invalidateSize();
                setTimeout(function() {
                    map.panBy([1, 0]);
                    map.panBy([-1, 0]);
                }, 50);
            }, 400);
        });

        map.addLayer(markerClusterGroup);

        // State
        let markers = [];
        let activeFilters = {
            venueType: [],
            cuisineType: [],
            ageRange: [],
            amenities: []
        };
        let searchQuery = '';
        let isInitialLoad = true;
        let activeTab = 'map';
        const favoritesKey = 'friendlyspaces_favorites';
        let favorites = new Set();
        const sidebar = document.getElementById('sidebar');
        const mobileFilterToggle = document.getElementById('mobile-filter-toggle');
        const sheetBackdrop = document.getElementById('sheet-backdrop');
        const mapPanel = document.getElementById('map');
        const listPanel = document.getElementById('list-view');
        const listCards = document.getElementById('list-cards');
        const listEmpty = document.getElementById('list-empty');
        const bottomTabs = document.querySelectorAll('#bottom-tabs .bottom-tab-button');
        const detailModal = document.getElementById('detail-modal');
        const detailModalContent = document.getElementById('detail-modal-content');

        // City coordinates for zoom
        const cityCoordinates = {
            'bern': [46.9480, 7.4474, 13],
            'basel': [47.5596, 7.5886, 13]
        };

        const isMobile = () => window.matchMedia('(max-width: 768px)').matches;

        function loadFavorites() {
            try {
                const raw = localStorage.getItem(favoritesKey);
                const parsed = raw ? JSON.parse(raw) : [];
                favorites = new Set(Array.isArray(parsed) ? parsed : []);
            } catch (err) {
                favorites = new Set();
            }
        }

        function saveFavorites() {
            localStorage.setItem(favoritesKey, JSON.stringify(Array.from(favorites)));
        }

        function isFavorite(venueName) {
            return favorites.has(venueName);
        }

        function toggleFavorite(venueName) {
            if (favorites.has(venueName)) {
                favorites.delete(venueName);
            } else {
                favorites.add(venueName);
            }
            saveFavorites();
            updateFavoritesBadge();
            updateMap();
            updateListView();
        }

        function updateFavoritesBadge() {
            const bottomBadge = document.getElementById('bottom-favorites-count');
            if (bottomBadge) bottomBadge.textContent = favorites.size;
        }

        function renderCountWrappers() {
            const resultCount = document.getElementById('result-count');
            const mobileCount = document.querySelector('#mobile-summary-bar .count');
            const showingLabel = translate('ui.showingLabel', 'Showing');
            const venuesLabel = translate('ui.venuesLabel', 'venues');

            if (resultCount) {
                resultCount.innerHTML = `${showingLabel} <strong id="venue-count">0</strong> ${venuesLabel}`;
            }

            if (mobileCount) {
                mobileCount.innerHTML = `${showingLabel} <strong id="venue-count-mobile">0</strong> ${venuesLabel}`;
            }
        }

        function applyTranslations() {
            document.title = translate('ui.title', document.title);
            const appTitle = document.getElementById('app-title');
            if (appTitle) appTitle.textContent = translate('ui.title', appTitle.textContent);
            const sidebarTitle = document.getElementById('sidebar-title');
            if (sidebarTitle) sidebarTitle.textContent = translate('ui.sidebarTitle', sidebarTitle.textContent);

            const searchInputEl = document.getElementById('search-input');
            if (searchInputEl) searchInputEl.placeholder = translate('ui.searchPlaceholder', searchInputEl.placeholder);

            const topSearchInputEl = document.getElementById('top-search-input');
            if (topSearchInputEl) topSearchInputEl.placeholder = translate('ui.searchPlaceholder', topSearchInputEl.placeholder);

            const mobileToggle = document.getElementById('mobile-filter-toggle');
            if (mobileToggle) mobileToggle.textContent = translate('ui.filtersLabel', mobileToggle.textContent);

            const clearBtn = document.getElementById('clear-filters');
            if (clearBtn) clearBtn.textContent = translate('ui.clearFilters', clearBtn.textContent);

            const mapTab = document.getElementById('bottom-tab-map');
            if (mapTab) mapTab.textContent = translate('ui.mapTab', mapTab.textContent);

            const listTab = document.getElementById('bottom-tab-list');
            if (listTab) listTab.textContent = translate('ui.listTab', listTab.textContent);

            const favoritesTab = document.getElementById('bottom-tab-favorites-label');
            if (favoritesTab) favoritesTab.textContent = translate('ui.favoritesTab', favoritesTab.textContent);

            const installBannerText = document.getElementById('install-banner-text');
            if (installBannerText) installBannerText.textContent = translate('ui.favoritesInstall', installBannerText.textContent);
            const installButton = document.getElementById('install-button');
            if (installButton) installButton.textContent = translate('ui.favoritesInstallCta', installButton.textContent);

            document.querySelectorAll('[data-category-heading]').forEach(heading => {
                const cat = heading.getAttribute('data-category-heading');
                heading.textContent = translate(`filters.categories.${cat}`, heading.textContent);
            });

            renderCountWrappers();
        }

        function updateLanguageToggleActive() {
            const buttons = document.querySelectorAll('#language-toggle button');
            buttons.forEach(btn => {
                const lang = btn.getAttribute('data-lang');
                btn.classList.toggle('active', lang === currentLang);
            });
        }

        function setLanguage(lang, { skipUrlUpdate = false } = {}) {
            if (!supportedLanguages.includes(lang)) return;
            currentLang = lang;
            document.documentElement.lang = lang;
            try {
                localStorage.setItem(languageKey, lang);
            } catch (err) {
                // Ignore storage errors.
            }

            if (!skipUrlUpdate) {
                const url = new URL(window.location.href);
                url.searchParams.set('lang', lang);
                history.replaceState({}, '', url.toString());
            }

            applyTranslations();
            updateLanguageToggleActive();
            createFilterButtons();
            updateFilterCount();
            updateMap();
            updateListView();
        }

        function openFilterSheet() {
            if (!isMobile()) return;
            sidebar.classList.add('show');
            sheetBackdrop.classList.add('visible');
            document.body.style.overflow = 'hidden';
        }

        function closeFilterSheet(force = false) {
            if (!isMobile() && !force) return;
            sidebar.classList.remove('show');
            sheetBackdrop.classList.remove('visible');
            document.body.style.overflow = isMobile() ? 'auto' : 'hidden';
        }

        function setupAccordions() {
            document.querySelectorAll('.filter-category h3').forEach(header => {
                header.addEventListener('click', () => {
                    if (!isMobile()) return;
                    header.parentElement.classList.toggle('collapsed');
                });
            });
        }

        function collapseFiltersForMobile() {
            const categories = document.querySelectorAll('.filter-category');

            if (!isMobile()) {
                categories.forEach(cat => cat.classList.remove('collapsed'));
                return;
            }

            categories.forEach((cat, index) => {
                cat.classList.toggle('collapsed', index !== 0);
            });
        }

        function handleResize() {
            collapseFiltersForMobile();
            if (!isMobile()) {
                closeFilterSheet(true);
                document.body.style.overflow = 'hidden';
            } else {
                document.body.style.overflow = 'auto';
            }
            if (mapPanel && !mapPanel.classList.contains('hidden')) {
                setTimeout(() => map.invalidateSize(), 100);
            }
        }

        // Helper: Count venues with specific filter
        function countVenuesWithFilter(category, filterId) {
            return venues.filter(v => v.filters[category].includes(filterId)).length;
        }

        // Create filter buttons
        function createFilterButtons() {
            Object.keys(filterDefinitions).forEach(category => {
                const container = document.getElementById(`${category}-filters`);
                if (!container) return;
                container.innerHTML = '';

                const heading = document.querySelector(`[data-category-heading="${category}"]`);
                if (heading) {
                    heading.textContent = translate(`filters.categories.${category}`, heading.textContent);
                }

                filterDefinitions[category].forEach(filter => {
                    const count = countVenuesWithFilter(category, filter.id);

                    const button = document.createElement('button');
                    button.className = 'filter-button';
                    if (activeFilters[category].includes(filter.id)) {
                        button.classList.add('active');
                    }
                    button.dataset.category = category;
                    button.dataset.value = filter.id;

                    const labelSpan = document.createElement('span');
                    const labelText = translate(`filters.options.${category}.${filter.id}`, filter.label || filter.id);
                    labelSpan.textContent = typeof labelText === 'function' ? labelText() : labelText;

                    const countSpan = document.createElement('span');
                    countSpan.className = 'count';
                    countSpan.textContent = count;

                    button.appendChild(labelSpan);
                    button.appendChild(countSpan);

                    button.addEventListener('click', () => handleFilterClick(button, category, filter.id));

                    container.appendChild(button);
                });
            });
        }

        // Handle filter button clicks
        function handleFilterClick(button, category, value) {
            button.classList.toggle('active');

            if (button.classList.contains('active')) {
                activeFilters[category].push(value);
            } else {
                activeFilters[category] = activeFilters[category].filter(v => v !== value);
            }

            updateMap();
            updateFilterCount();
        }

        // Search functionality with dropdown
        const searchInput = document.getElementById('search-input');
        const searchDropdown = document.getElementById('search-dropdown');
        const topSearchInput = document.getElementById('top-search-input');
        const topSearchDropdown = document.getElementById('top-search-dropdown');

        function updateSearchDropdown(query, dropdownEl) {
            const targetDropdown = dropdownEl || searchDropdown;
            const isTopSearch = targetDropdown === topSearchDropdown;
            const itemClass = isTopSearch ? 'top-search-dropdown-item' : 'search-dropdown-item';

            if (!query || query.length < 2) {
                targetDropdown.classList.remove('show');
                return;
            }

            const suggestions = [];

            // Add matching cities
            Object.keys(cityCoordinates).forEach(city => {
                if (city.toLowerCase().includes(query)) {
                    const venueCount = venues.filter(v => v.city.toLowerCase() === city.toLowerCase()).length;
                    const countLabel = translate('ui.cityCount', `${venueCount} venues`);
                    suggestions.push({
                        type: 'city',
                        name: city.charAt(0).toUpperCase() + city.slice(1),
                        count: typeof countLabel === 'function' ? countLabel(venueCount) : countLabel
                    });
                }
            });

            // Add matching venues
            venues.forEach(venue => {
                if (venue.name.toLowerCase().includes(query) ||
                    venue.address.toLowerCase().includes(query)) {
                    suggestions.push({
                        type: 'venue',
                        name: venue.name,
                        city: venue.city,
                        venue: venue
                    });
                }
            });

            if (suggestions.length === 0) {
                targetDropdown.classList.remove('show');
                return;
            }

            // Limit to 5 suggestions
            const limitedSuggestions = suggestions.slice(0, 5);

            targetDropdown.innerHTML = limitedSuggestions.map(s => {
                if (s.type === 'city') {
                    return `<div class="${itemClass}" data-type="city" data-city="${s.name.toLowerCase()}">
                        <strong>📍 ${s.name}</strong> - ${s.count}
                    </div>`;
                } else {
                    return `<div class="${itemClass}" data-type="venue" data-venue="${s.name}">
                        ${s.name} <span class="city-label">- ${s.city}</span>
                    </div>`;
                }
            }).join('');

            targetDropdown.classList.add('show');

            // Add click handlers
            targetDropdown.querySelectorAll(`.${itemClass}`).forEach(item => {
                item.addEventListener('click', () => {
                    const type = item.dataset.type;
                    if (type === 'city') {
                        const city = item.dataset.city;
                        handleCitySearch(city, isTopSearch);
                    } else {
                        const venueName = item.dataset.venue;
                        handleVenueSearch(venueName, isTopSearch);
                    }
                });
            });
        }

        function handleCitySearch(city, fromTopSearch = false) {
            const displayCity = city.charAt(0).toUpperCase() + city.slice(1);
            searchInput.value = displayCity;
            topSearchInput.value = displayCity;
            searchQuery = city.toLowerCase();
            searchDropdown.classList.remove('show');
            topSearchDropdown.classList.remove('show');

            // Zoom to city
            const coords = cityCoordinates[city.toLowerCase()];
            if (coords) {
                map.setView([coords[0], coords[1]], coords[2]);
            }

            updateMap();
        }

        function handleVenueSearch(venueName, fromTopSearch = false) {
            const venue = venues.find(v => v.name === venueName);
            if (venue) {
                searchInput.value = venue.name;
                topSearchInput.value = venue.name;
                searchQuery = venue.name.toLowerCase();
                searchDropdown.classList.remove('show');
                topSearchDropdown.classList.remove('show');

                // Zoom to venue
                map.setView(venue.fallbackCoords, 15);

                updateMap();

                // Open venue popup after a short delay
                setTimeout(() => {
                    const marker = markers.find(m => m.venue.name === venueName);
                    if (marker) {
                        marker.marker.openPopup();
                    }
                }, 300);
            }
        }

        // Sync both search inputs
        function syncSearchInputs(sourceInput, sourceDropdown) {
            searchQuery = sourceInput.value.toLowerCase();

            // Sync the other input
            if (sourceInput === searchInput) {
                topSearchInput.value = sourceInput.value;
                updateSearchDropdown(searchQuery, searchDropdown);
            } else {
                searchInput.value = sourceInput.value;
                updateSearchDropdown(searchQuery, topSearchDropdown);
            }

            updateMap();
        }

        searchInput.addEventListener('input', (e) => {
            syncSearchInputs(searchInput, searchDropdown);
        });

        topSearchInput.addEventListener('input', (e) => {
            syncSearchInputs(topSearchInput, topSearchDropdown);
        });

        searchInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && searchQuery) {
                const cityMatch = Object.keys(cityCoordinates).find(city =>
                    city === searchQuery ||
                    searchQuery.includes(city)
                );

                if (cityMatch) {
                    handleCitySearch(cityMatch);
                } else {
                    searchDropdown.classList.remove('show');
                }
            }
        });

        topSearchInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && searchQuery) {
                const cityMatch = Object.keys(cityCoordinates).find(city =>
                    city === searchQuery ||
                    searchQuery.includes(city)
                );

                if (cityMatch) {
                    handleCitySearch(cityMatch, true);
                } else {
                    topSearchDropdown.classList.remove('show');
                }
            }
        });

        // Close dropdowns when clicking outside
        document.addEventListener('click', (e) => {
            if (!searchInput.contains(e.target) && !searchDropdown.contains(e.target)) {
                searchDropdown.classList.remove('show');
            }
            if (!topSearchInput.contains(e.target) && !topSearchDropdown.contains(e.target)) {
                topSearchDropdown.classList.remove('show');
            }
        });

        // Clear filters
        document.getElementById('clear-filters').addEventListener('click', () => {
            // Remove active class from all filter buttons
            document.querySelectorAll('.filter-button.active').forEach(btn => {
                btn.classList.remove('active');
            });

            // Reset active filters
            Object.keys(activeFilters).forEach(key => {
                activeFilters[key] = [];
            });

            // Clear search
            document.getElementById('search-input').value = '';
            document.getElementById('top-search-input').value = '';
            searchQuery = '';

            // Reset map view to show all venues
            isInitialLoad = true;
            updateMap();
            updateFilterCount();
        });

        // Update filter count display
        function updateFilterCount() {
            const total = Object.values(activeFilters).flat().length;
            const countEl = document.getElementById('filter-count');
            const clearBtn = document.getElementById('clear-filters');

            const filterActiveText = translate('ui.filtersActive');
            countEl.textContent = typeof filterActiveText === 'function'
                ? filterActiveText(total)
                : `${total} filter${total !== 1 ? 's' : ''} active`;
            clearBtn.disabled = total === 0 && !searchQuery;

            const mobileToggleEl = document.getElementById('mobile-filter-toggle');
            if (mobileToggleEl) {
                const filtersButtonText = translate('ui.filtersButton');
                if (typeof filtersButtonText === 'function') {
                    mobileToggleEl.textContent = filtersButtonText(total);
                } else {
                    mobileToggleEl.textContent = filtersButtonText || (total > 0 ? `Filters (${total})` : 'Filters');
                }
            }
        }

        // Check if venue matches filters
        function venueMatchesFilters(venue) {
            if (activeTab === 'favorites' && !isFavorite(venue.name)) {
                return false;
            }

            // Search filter
            if (searchQuery) {
                const searchMatch =
                    venue.name.toLowerCase().includes(searchQuery) ||
                    venue.address.toLowerCase().includes(searchQuery) ||
                    venue.city.toLowerCase().includes(searchQuery);

                if (!searchMatch) return false;
            }

            // Category filters (AND logic - venue must have ALL selected filters)
            for (const [category, selectedFilters] of Object.entries(activeFilters)) {
                if (selectedFilters.length > 0) {
                    // Check if venue has ALL selected filters in this category
                    const hasAllFilters = selectedFilters.every(filter =>
                        venue.filters[category].includes(filter)
                    );
                    if (!hasAllFilters) return false;
                }
            }

            return true;
        }

        function getVisibleVenues() {
            return venues.filter(venueMatchesFilters);
        }

        // Color scheme for filter categories
        const categoryColors = {
            venueType: '#3b82f6',      // Blue
            cuisineType: '#10b981',    // Green
            ageRange: '#f59e0b',       // Orange
            amenities: '#8b5cf6'       // Purple
        };

        // Create popup content with color-coded tags and image slider
        function createPopup(venue) {
            const visitWebsiteLabel = translate('popup.visitWebsite', 'Visit Website');
            const hoursLabel = translate('popup.hours', 'Hours');
            const specialtyLabel = translate('popup.specialty', 'Specialty');
            const favoriteAddLabel = translate('ui.favoriteAdd', 'Save');
            const favoriteRemoveLabel = translate('ui.favoriteRemove', 'Saved');
            const seasonalNote = venue.seasonalNote
                ? (venue.seasonalNote[currentLang] || venue.seasonalNote.en || venue.seasonalNote.de)
                : null;

            const localizedDescription = getVenueText(venue, 'description');
            const localizedHours = getVenueText(venue, 'hours');
            const localizedSpecialty = getVenueText(venue, 'specialty');

            const tagsByCategory = Object.entries(venue.filters)
                .map(([category, values]) => {
                    const color = categoryColors[category];
                    const tags = values.map(v => {
                        const def = filterDefinitions[category].find(f => f.id === v);
                        const translated = translate(`filters.options.${category}.${v}`, def?.label || v);
                        const label = typeof translated === 'function' ? translated() : translated;
                        return `<span class="venue-tag" style="background: ${color}; color: white;">${label}</span>`;
                    }).join('');
                    return tags;
                })
                .join('');

            // Create Google Maps directions link
            const mapsUrl = `https://www.google.com/maps/dir/?api=1&destination=${encodeURIComponent(venue.address)}`;
            const phoneHref = formatPhoneHref(venue.phone);

            // Website link (if available)
            const websiteHtml = venue.website
                ? `<p style="margin: 5px 0; font-size: 13px;"><strong>🌐</strong> <a href="${venue.website}" target="_blank" rel="noopener noreferrer" style="color: #1E52BA; text-decoration: none;">${visitWebsiteLabel}</a></p>`
                : '';

            // Image slider (if images available)
            let sliderHtml = '';
            if (venue.images && venue.images.length > 0) {
                const sliderId = `slider-${venue.name.replace(/\s+/g, '-').toLowerCase()}`;
                const imagesHtml = venue.images.map((img, i) =>
                    `<img src="${img}" alt="${venue.name}" loading="${i === 0 ? 'eager' : 'lazy'}" decoding="async" ${i === 0 ? 'fetchpriority="high"' : 'fetchpriority="low"'} width="320" height="150">`
                ).join('');
                const dotsHtml = venue.images.map((_, i) =>
                    `<span class="slider-dot ${i === 0 ? 'active' : ''}" data-slide="${i}"></span>`
                ).join('');

                sliderHtml = `
                    <div class="venue-slider" id="${sliderId}">
                        <div class="slider-container">${imagesHtml}</div>
                        ${venue.images.length > 1 ? `
                            <button class="slider-arrow prev" onclick="slideImage('${sliderId}', -1)">‹</button>
                            <button class="slider-arrow next" onclick="slideImage('${sliderId}', 1)">›</button>
                            <div class="slider-dots">${dotsHtml}</div>
                        ` : ''}
                    </div>
                `;
            }

            return `
                <div style="min-width: 240px; max-width: 300px;">
                    ${sliderHtml}
                    <div style="display: flex; align-items: center; justify-content: space-between; gap: 8px; margin: 0 0 10px 0;">
                        <h3 style="margin: 0; font-size: 16px;">${venue.name}</h3>
                        <button class="favorite-toggle ${isFavorite(venue.name) ? 'active' : ''}" data-venue="${venue.name}">
                            <span class="favorite-heart">${isFavorite(venue.name) ? '♥' : '♡'}</span>
                            <span class="favorite-label">${isFavorite(venue.name) ? favoriteRemoveLabel : favoriteAddLabel}</span>
                        </button>
                    </div>
                    <p style="margin: 5px 0; font-size: 13px;"><strong>📍</strong> <a href="${mapsUrl}" target="_blank" rel="noopener noreferrer" style="color: #1E52BA; text-decoration: none;">${venue.address}</a></p>
                    <p style="margin: 5px 0; font-size: 13px;"><strong>📞</strong> ${phoneHref ? `<a href="${phoneHref}" style="color: #1E52BA; text-decoration: none;">${venue.phone}</a>` : venue.phone}</p>
                    ${websiteHtml}
                    <p style="margin: 8px 0; font-size: 13px;">${localizedDescription}</p>
                    <p style="margin: 5px 0; font-size: 12px; color: #666;"><strong>${hoursLabel}:</strong> ${localizedHours}</p>
                    ${seasonalNote ? `<p style="margin: 5px 0; font-size: 12px; color: #BA1E1E;"><strong>${seasonalNote}</strong></p>` : ''}
                    <p style="margin: 5px 0; font-size: 12px; color: #1E52BA;"><strong>${specialtyLabel}:</strong> ${localizedSpecialty}</p>
                    <div class="venue-tags">${tagsByCategory}</div>
                </div>
            `;
        }

        // Update map markers
        function updateMap() {
            // Clear existing markers from cluster group
            markerClusterGroup.clearLayers();
            markers = [];

            const bounds = L.latLngBounds([]);
            let visibleCount = 0;
            const visibleVenues = getVisibleVenues();

            // Add markers for matching venues
            visibleVenues.forEach(venue => {
                if (!Array.isArray(venue.fallbackCoords) || venue.fallbackCoords.length < 2) {
                    return;
                }
                const coords = venue.fallbackCoords;
                const marker = L.marker(coords, { icon: markerIcon });
                marker.bindPopup(createPopup(venue), {
                    className: 'custom-popup',
                    maxWidth: 340,
                    minWidth: 240,
                    autoPanPaddingTopLeft: [40, 40],
                    autoPanPaddingBottomRight: [40, 40]
                });
                marker.on('popupopen', (e) => {
                    const target = e.popup.getLatLng();
                    map.panTo(target, { animate: true });
                    // Nudge popup fully into view; try a stronger upward pan
                    setTimeout(() => map.panBy([0, -140], { animate: true }), 150);

                    const sliderEl = e.popup.getElement()?.querySelector('.slider-container');
                    attachSliderScrollSync(sliderEl);
                    attachFavoriteHandlers(e.popup.getElement());
                });

                // Add marker to cluster group instead of directly to map
                markerClusterGroup.addLayer(marker);

                markers.push({ venue, marker, coords });
                bounds.extend(coords);
                visibleCount++;
            });

            // Update count
            document.getElementById('venue-count').textContent = visibleCount;
            const mobileCountEl = document.getElementById('venue-count-mobile');
            if (mobileCountEl) {
                mobileCountEl.textContent = visibleCount;
            }

            // Only auto-zoom on initial load
            if (isInitialLoad) {
                if (bounds.isValid()) {
                    map.fitBounds(bounds.pad(0.2));
                } else {
                    map.setView([46.9480, 7.4474], 13);
                }
                isInitialLoad = false;
            }
            updateListView();
        }

        function renderVenueCard(venue) {
            const description = getVenueText(venue, 'description');
            const image = venue.images && venue.images.length > 0 ? venue.images[0] : '';
            const isFav = isFavorite(venue.name);
            const tags = venue.filters?.venueType || [];
            const tagHtml = tags.map(tag => {
                const def = filterDefinitions.venueType.find(item => item.id === tag);
                const translated = translate(`filters.options.venueType.${tag}`, def?.label || tag);
                const label = typeof translated === 'function' ? translated() : translated;
                return `<span class="venue-card-tag">${label}</span>`;
            }).join('');

            return `
                <article class="venue-card" data-venue="${venue.name}">
                    ${image
                        ? `<img class="venue-card-image" src="${image}" alt="${venue.name}" loading="lazy" decoding="async">`
                        : `<div class="venue-card-image" aria-hidden="true"></div>`}
                    <div class="venue-card-header">
                        <h3 class="venue-card-title">${venue.name}</h3>
                        <button class="venue-card-favorite ${isFav ? 'active' : ''}" data-venue="${venue.name}" type="button">
                            <span>${isFav ? '★' : '☆'}</span>
                        </button>
                    </div>
                    <div class="venue-card-meta">${venue.city}</div>
                    <div class="venue-card-address">${venue.address}</div>
                    <div class="venue-card-description">${description}</div>
                    <div class="venue-card-tags">${tagHtml}</div>
                </article>
            `;
        }

        function updateListView() {
            if (!listCards || !listEmpty) return;
            const visibleVenues = getVisibleVenues();
            listCards.innerHTML = visibleVenues.map(renderVenueCard).join('');

            const emptyTitle = activeTab === 'favorites'
                ? translate('ui.noFavoritesTitle', 'No favorites yet')
                : translate('ui.noVenuesTitle', 'No venues found');
            const emptyBody = activeTab === 'favorites'
                ? translate('ui.noFavoritesBody', 'Tap the heart to save places.')
                : translate('ui.noVenuesBody', 'Try clearing filters or searching another city.');

            listEmpty.hidden = visibleVenues.length > 0;
            listCards.hidden = visibleVenues.length === 0;
            listEmpty.innerHTML = `<strong style="display:block; margin-bottom:6px;">${emptyTitle}</strong>${emptyBody}`;
        }

        function openDetailModal(venue) {
            if (!detailModal || !detailModalContent) return;
            detailModalContent.innerHTML = createPopup(venue);
            detailModal.classList.add('active');
            detailModal.setAttribute('aria-hidden', 'false');
            attachFavoriteHandlers(detailModalContent);
            const sliderEl = detailModalContent.querySelector('.slider-container');
            attachSliderScrollSync(sliderEl);
        }

        function closeDetailModal() {
            if (!detailModal) return;
            detailModal.classList.remove('active');
            detailModal.setAttribute('aria-hidden', 'true');
        }

        function setActiveView(view) {
            activeTab = view;
            bottomTabs.forEach(btn => {
                btn.classList.toggle('active', btn.dataset.view === view);
            });
            const showMap = view === 'map';
            if (mapPanel) mapPanel.classList.toggle('hidden', !showMap);
            if (listPanel) listPanel.classList.toggle('hidden', showMap);
            if (showMap) {
                setTimeout(() => map.invalidateSize(), 100);
            }
            closeDetailModal();
            updateMap();
            updateListView();
        }

        if (mobileFilterToggle) {
            mobileFilterToggle.addEventListener('click', () => {
                if (sidebar.classList.contains('show')) {
                    closeFilterSheet();
                } else {
                    openFilterSheet();
                }
            });
        }

        if (sheetBackdrop) {
            sheetBackdrop.addEventListener('click', () => closeFilterSheet());
        }

        window.addEventListener('resize', handleResize);

        // Image slider functionality
        const sliderIndices = {};

        function slideImage(sliderId, direction) {
            const slider = document.getElementById(sliderId);
            if (!slider) return;

            const sliderContainer = slider.querySelector('.slider-container');
            const images = sliderContainer.querySelectorAll('img');
            const dots = slider.querySelectorAll('.slider-dot');

            if (!sliderIndices[sliderId]) {
                sliderIndices[sliderId] = 0;
            }

            // Calculate new index
            sliderIndices[sliderId] = (sliderIndices[sliderId] + direction + images.length) % images.length;

            // Update slider position via scroll
            const slideWidth = sliderContainer.clientWidth || slider.clientWidth;
            const targetScroll = sliderIndices[sliderId] * slideWidth;
            sliderContainer.scrollTo({ left: targetScroll, behavior: 'smooth' });

            // Update dots
            dots.forEach((dot, index) => {
                if (index === sliderIndices[sliderId]) {
                    dot.classList.add('active');
                } else {
                    dot.classList.remove('active');
                }
            });
        }

        // Make slideImage globally accessible for onclick handlers
        window.slideImage = slideImage;

        function attachSliderScrollSync(sliderEl) {
            if (!sliderEl || sliderEl.dataset.bound === 'true') return;
            const sliderId = sliderEl.closest('.venue-slider')?.id;
            if (!sliderId) return;
            sliderEl.dataset.bound = 'true';
            const dots = sliderEl.parentElement.querySelectorAll('.slider-dot');
            sliderEl.addEventListener('scroll', () => {
                const slideWidth = sliderEl.clientWidth || 1;
                const idx = Math.round(sliderEl.scrollLeft / slideWidth);
                sliderIndices[sliderId] = idx;
                dots.forEach((dot, i) => dot.classList.toggle('active', i === idx));
            });
        }

        function attachFavoriteHandlers(popupEl) {
            if (!popupEl) return;
            const btn = popupEl.querySelector('.favorite-toggle');
            if (!btn || btn.dataset.bound === 'true') return;
            btn.dataset.bound = 'true';
            btn.addEventListener('click', (e) => {
                e.preventDefault();
                const venueName = btn.dataset.venue;
                toggleFavorite(venueName);
                const isFav = isFavorite(venueName);
                btn.classList.toggle('active', isFav);
                const heart = btn.querySelector('.favorite-heart');
                const label = btn.querySelector('.favorite-label');
                if (heart) heart.textContent = isFav ? '♥' : '♡';
                if (label) label.textContent = isFav
                    ? translate('ui.favoriteRemove', 'Saved')
                    : translate('ui.favoriteAdd', 'Save');
            });
        }

        bottomTabs.forEach(btn => {
            btn.addEventListener('click', () => {
                setActiveView(btn.dataset.view || 'map');
            });
        });

        const languageButtons = document.querySelectorAll('#language-toggle button');
        languageButtons.forEach(btn => {
            btn.addEventListener('click', () => {
                const lang = btn.getAttribute('data-lang');
                setLanguage(lang);
            });
        });

        if (listCards) {
            listCards.addEventListener('click', (event) => {
                const favoriteButton = event.target.closest('.venue-card-favorite');
                if (favoriteButton) {
                    event.preventDefault();
                    event.stopPropagation();
                    const venueName = favoriteButton.dataset.venue;
                    toggleFavorite(venueName);
                    return;
                }

                const card = event.target.closest('.venue-card');
                if (!card) return;
                const venueName = card.dataset.venue;
                const venue = venues.find(v => v.name === venueName);
                if (venue) openDetailModal(venue);
            });
        }

        const modalClose = document.getElementById('detail-modal-close');
        if (modalClose) {
            modalClose.addEventListener('click', closeDetailModal);
        }

        if (detailModal) {
            detailModal.addEventListener('click', (event) => {
                if (event.target === detailModal) {
                    closeDetailModal();
                }
            });
        }

        document.addEventListener('keydown', (event) => {
            if (event.key === 'Escape') {
                closeDetailModal();
            }
        });

        // Install prompt banner
        let deferredPrompt = null;
        const installBanner = document.getElementById('install-banner');
        const installButton = document.getElementById('install-button');

        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            if (installBanner) installBanner.classList.remove('hidden');
        });

        if (installButton) {
            installButton.addEventListener('click', async () => {
                if (!deferredPrompt) return;
                deferredPrompt.prompt();
                await deferredPrompt.userChoice;
                deferredPrompt = null;
                if (installBanner) installBanner.classList.add('hidden');
            });
        }

        window.addEventListener('appinstalled', () => {
            if (installBanner) installBanner.classList.add('hidden');
        });

        // Initialize
        loadFavorites();
        updateFavoritesBadge();
        setLanguage(currentLang, { skipUrlUpdate: true });
        setupAccordions();
        handleResize();

        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js').catch(() => {});
            });
        }
    </script>
</body>
</html>
